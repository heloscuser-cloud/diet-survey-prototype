<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>국가검진 간편인증</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; margin: 20px; }
    .row { display:block; margin: 10px 0; }
    .row-inline { display:flex; align-items:center; gap:10px; margin:10px 0; flex-wrap:wrap; }
    label { min-width: 88px; display:inline-block; }
    input[type="text"], select { padding:8px; border:1px solid #ccc; border-radius:6px; min-width: 220px; }
    button { padding:10px 14px; border:0; border-radius:8px; background:#111827; color:white; cursor:pointer; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    #status { margin-top: 8px; font-size: 12px; }
    #status.ok { color: #047857; }
    #status.warn { color: #b45309; }
    #status.err { color: #b91c1c; }
    .hint { font-size: 12px; color:#6b7280; margin-left: 6px; }
    .gender-label { font-weight:600; margin-right:8px; }
    .gender-wrap { display:flex; align-items:center; gap:14px; }
    .gender-wrap label { display:inline-flex; align-items:center; gap:6px; }
    .gender-wrap span { font-size: 11pt; } /* ★ 남/여 11pt */
  </style>
</head>
<body>
  <h2>국가검진 간편인증</h2>

  <div class="row-inline">
    <label for="loginSel">인증수단</label>
    <select id="loginSel">
      <option value="0">카카오톡</option>
      <option value="1">삼성패스</option>
      <option value="2">페이코</option>
      <option value="3">통신사 PASS</option>
      <option value="4">KB 모바일</option>
      <option value="5">네이버 인증서</option>
      <option value="6">신한 인증서</option>
      <option value="7">토스 인증서</option>
    </select>

    <label for="telecomSel">통신사</label>
    <select id="telecomSel" disabled>
      <option value="">(선택)</option>
      <option value="1">KT</option>
      <option value="2">SKT</option>
      <option value="3">LG U+</option>
      <option value="4">KT 알뜰폰</option>
      <option value="5">SKT 알뜰폰</option>
      <option value="6">LG 알뜰폰</option>
    </select>
    <span class="hint">※ 통신사 PASS 선택 시 필수</span>
  </div>

  <div class="row-inline">
    <label for="nameEl">이름</label>
    <input id="nameEl" type="text" placeholder="홍길동" />
  </div>

  <div class="row-inline">
    <label for="birthEl">생년월일</label>
    <input id="birthEl" type="text" inputmode="numeric" maxlength="8" placeholder="YYYYMMDD (8자리)" />
  </div>

  <!-- ★ 성별 (라벨 포함, 남/여 11pt) -->
  <div class="row-inline">
    <span class="gender-label">성별</span>
    <div class="gender-wrap">
      <label><input type="radio" name="pre_gender" value="남" /> <span>남</span></label>
      <label><input type="radio" name="pre_gender" value="여" /> <span>여</span></label>
    </div>
  </div>

  <div class="row-inline">
    <label for="phoneEl">휴대폰</label>
    <input id="phoneEl" type="text" inputmode="tel" placeholder="010-1234-5678" />
    <span class="hint">하이픈(-) 포함/미포함 모두 가능</span>
  </div>

  <div class="row-inline" style="gap:10px">
    <button id="btnStart">간편인증 시작</button>
    <button id="btnComplete" disabled>인증완료</button>
  </div>

  <div id="status"></div>

  <script>
    // ====== 요소 참조 ======
    const loginSel   = document.querySelector('#loginSel');
    const telecomSel = document.querySelector('#telecomSel');
    const nameEl     = document.querySelector('#nameEl');
    const birthEl    = document.querySelector('#birthEl');
    const phoneEl    = document.querySelector('#phoneEl');
    const btnStart   = document.querySelector('#btnStart');
    const btnComplete= document.querySelector('#btnComplete');
    const statusEl   = document.querySelector('#status');

    // ====== 상태 ======
    let callbackId = "";
    let gStartDone = false;

    // ====== 유틸 ======
    function setStatus(msg, cls) {
      statusEl.className = ""; 
      if (cls) statusEl.classList.add(cls);
      statusEl.textContent = msg || "";
    }
    function resetAuthState() {
      callbackId = "";
      gStartDone = false;
      if (btnComplete) btnComplete.disabled = true;
    }
    function normalizePhone(v) {
      if (!v) return "";
      const d = (v+"").replace(/[^0-9]/g, "");
      if (d.length === 10) return d.replace(/(\d{3})(\d{3})(\d{4})/, "$1-$2-$3");
      if (d.length === 11) return d.replace(/(\d{3})(\d{4})(\d{4})/, "$1-$2-$3");
      return d;
    }
    function validateBirth8(v) {
      return /^[0-9]{8}$/.test(v);
    }

    // 통신사 PASS 선택 시 통신사 콤보 활성/비활성
    loginSel.addEventListener('change', () => {
      telecomSel.disabled = (loginSel.value !== '3');
    });

    // 입력 보조
    birthEl.addEventListener('input', () => {
      birthEl.value = birthEl.value.replace(/[^0-9]/g, '').slice(0, 8);
    });
    phoneEl.addEventListener('blur', () => {
      phoneEl.value = normalizePhone(phoneEl.value.trim());
    });

    // ====== 시작 버튼 ======
    btnStart.addEventListener('click', async () => {
      // 성별 필수
      const gEl = document.querySelector('input[name="pre_gender"]:checked');
      if (!gEl) {
        alert('성별을 입력해주세요');
        return;
      }
      const preGender = gEl.value; // '남' or '여'

      // 폼 값
      const loginOption  = loginSel.value;                   // 0..7
      const telecom      = (loginOption === '3') ? telecomSel.value : '';
      const userName     = nameEl.value.trim();
      const hpNumber     = normalizePhone(phoneEl.value.trim());
      const juminOrBirth = birthEl.value.trim();

      // 기본 검증
      if (!userName) { alert('이름을 입력해주세요'); return; }
      if (!validateBirth8(juminOrBirth)) { alert('생년월일을 8자리(YYYYMMDD)로 입력해주세요'); return; }
      if (!hpNumber) { alert('휴대폰번호를 입력해주세요'); return; }
      if (loginOption === '3' && !telecom) { alert('통신사를 선택해주세요'); return; }

      // 새 트랜잭션 시작 → 상태 초기화
      resetAuthState();

      setStatus('인증 요청 중...');

      // 시작 요청 (세션 유지 중요!)
      const body = { loginOption, telecom, userName, hpNumber, juminOrBirth, gender: preGender };
      const rsp = await fetch('/api/dh/simple/start', {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });

      const data = await rsp.json().catch(() => ({}));
      console.log('[START][rsp]', rsp.status, data);

      // 기대 플로우: errCode=0001 + callbackId
      if (rsp.status === 200 && data && data.errCode === '0001' && data.data && data.data.callbackId) {
        callbackId = data.data.callbackId;
        gStartDone = true;
        btnComplete.disabled = false;
        setStatus('휴대폰에서 인증을 완료한 뒤 "인증완료"를 눌러주세요.', 'ok');
        return;
      }

      // 에러
      alert((data && (data.message || data.errMsg)) || '간편인증 시작에 실패했습니다.');
      setStatus('인증 시작 실패', 'err');
    });

    // ====== 인증완료 버튼 ======
    btnComplete.addEventListener('click', async () => {
      if (!gStartDone || !callbackId) {
        alert('먼저 "간편인증 시작"을 진행해주세요.');
        return;
      }

      const gEl = document.querySelector('input[name="pre_gender"]:checked');
      const preGender = gEl ? gEl.value : "";

      setStatus('인증 완료 확인 중...');
      btnComplete.disabled = true;

      async function tryCompleteOnce() {
        const rsp = await fetch('/api/dh/simple/complete?all=1', {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ callbackId, gender: preGender }),
        });
        const data = await rsp.json().catch(() => ({}));
        console.log('[COMPLETE][rsp]', rsp.status, data);

        if (rsp.status === 200 && data && data.ok) {
          setStatus('인증 및 데이터 수집 완료! 문진으로 이동합니다.', 'ok');
          // 바로 문진으로 이동
          window.location.href = '/survey';
          return true;
        }
        if (rsp.status === 202) {
          setStatus('인증완료 확인 중... 잠시만 기다려주세요.');
          return false; // 재시도
        }
        alert((data && (data.message || data.errMsg)) || '인증 확인 중 오류가 발생했습니다.');
        setStatus('오류가 발생했습니다. 다시 시도해 주세요.', 'err');
        return null; // 중단
      }

      // 폴링 루프
      const deadline = Date.now() + 60000; // 최대 60초
      while (Date.now() < deadline) {
        const r = await tryCompleteOnce();
        if (r === true) return;
        if (r === null) break;
        await new Promise(res => setTimeout(res, 2000));
      }

      alert('아직 인증이 완료되지 않았습니다. 휴대폰에서 인증을 완료한 뒤 다시 "인증완료"를 눌러주세요.');
      setStatus('인증 대기 상태입니다. 인증 완료 후 다시 "인증완료"를 눌러주세요.', 'warn');
      btnComplete.disabled = false;
    });
  </script>
</body>
</html>
