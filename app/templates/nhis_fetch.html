<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>êµ­ê°€ê±´ê°•ê²€ì§„ ë°ì´í„° ì¡°íšŒ</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  </style>
</head>
<body>
  <div class="container">
    <h1>êµ­ê°€ê±´ê°•ê²€ì§„ ë°ì´í„° ì¡°íšŒ</h1>
    <p class="muted">ê°„í¸ì¸ì¦ì„ ì™„ë£Œí•œ ë’¤ â€œë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°â€ë¥¼ ëˆ„ë¥´ë©´, ìµœê·¼ 10ë…„ ì¤‘ <b>ê°€ì¥ ìµœê·¼ ì¼ë°˜ê²€ì§„ 1ê±´</b>ì„ ì—°ê²°í•©ë‹ˆë‹¤.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>ê°„í¸ì¸ì¦ ìˆ˜ë‹¨</label>
          <select id="loginOption">
            <option value="" selected>-- ì„ íƒ --</option>
            <option value="0">ì¹´ì¹´ì˜¤í†¡</option>
	<option value="1">ì‚¼ì„±íŒ¨ìŠ¤</option>
	<option value="2">í˜ì´ì½”</option>
            <option value="3">í†µì‹ ì‚¬</option>
	<option value="4">KBëª¨ë°”ì¼ì¸ì¦ì„œ</option>
	<option value="5">ë„¤ì´ë²„</option>
	<option value="6">ì‹ í•œì¸ì¦ì„œ</option>
	<option value="7">í† ìŠ¤</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label>í†µì‹ ì‚¬(PASS ì„ íƒ ì‹œ)</label>
          <select id="telecom">
            <option value="" selected>-- ì„ íƒ --</option>
            <option value="1">SKT</option>
            <option value="2">KT</option>
            <option value="3">LGU+</option>
          </select>
        </div>
        <div>
          <label for="name">ì´ë¦„</label>
          <input id="name" type="text" placeholder="í™ê¸¸ë™" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone">íœ´ëŒ€í° ë²ˆí˜¸</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
<div>
  <label id="jLabel">ìƒë…„ì›”ì¼(8ìë¦¬)</label>

  <!-- PASS(3)ì¼ ë•Œ ë³´ì´ëŠ” ìƒë…„ì›”ì¼ 1ì¹¸ -->
  <input id="birthOne" inputmode="numeric" placeholder="19900307" style="display:none">

  <!-- ê·¸ ì™¸ ìˆ˜ë‹¨ì¼ ë•Œ ë³´ì´ëŠ” ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ 2ì¹¸ -->
  <div id="rrnWrap" class="row-inline" style="display:none">
    <input id="rrn1" inputmode="numeric" placeholder="######" maxlength="6" style="flex:1">
    <span>-</span>
    <input id="rrn2" inputmode="numeric" placeholder="#######" maxlength="7" style="flex:1">
  </div>
</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stack">
        <button type="button" id="btnStart" class="btn btn-primary" disabled>ê°„í¸ì¸ì¦ ì‹œì‘</button>
        <button type="button" id="btnComplete" class="btn btn-secondary" disabled>ì¸ì¦ ì™„ë£Œ í›„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div id="status" class="status"></div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

    <div class="stack">
      <a id="btnSkip" class="btn btn-secondary" href="{{ next_url or '/info' }}">ê±´ë„ˆë›°ê³  ê³„ì†</a>
      <a id="btnNext" class="btn btn-primary" href="{{ next_url or '/info' }}" aria-disabled="true" style="pointer-events:none;opacity:.5">ë‹¤ìŒ(ì •ë³´ ì…ë ¥ìœ¼ë¡œ)</a>
    </div>
  </div>

<script>
(function(){
  // ---------- ìœ í‹¸ ----------
  const $ = (s)=>document.querySelector(s);
  const onlyDigits = v => (v||"").replace(/[^0-9]/g,'');

  const setStatus=(m,k)=>{
    const el=$('#status');
    el.textContent=m||'';
    el.className='status'+(k?(' '+k):'');
  };

  // ---------- DOM ----------
  const loginSel   = $('#loginOption');
  const telecomRow = $('#telecomRow');
  const telecomSel = $('#telecom');
  const nameField  = $('#name');
  const phoneField = $('#phone');

  const jLabel   = $('#jLabel');
  const birthOne = $('#birthOne'); // PASS(3) ì „ìš©
  const rrnWrap  = $('#rrnWrap');  // ê¸°íƒ€ ìˆ˜ë‹¨ ì „ìš©
  const rrn1     = $('#rrn1');
  const rrn2     = $('#rrn2');

  const btnStart    = $('#btnStart');
  const btnComplete = $('#btnComplete');
  const btnNext     = $('#btnNext');
  const preview     = $('#preview');

  // ì„œë²„ì—ì„œ ë‚´ë ¤ì£¼ëŠ” AUTH ë² ì´ìŠ¤ (main.pyì—ì„œ datahub_auth_base ì „ë‹¬)
  const AUTH_BASE = "{{ datahub_auth_base }}/auth/simple";

  let callbackId = null;

  // ---------- ì…ë ¥ í•„í„° ----------
  phoneField.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,11);
    validateStartEnabled();
  });
  birthOne.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,8);
    validateStartEnabled();
  });
  rrn1.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,6);
    validateStartEnabled();
  });
  rrn2.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,7);
    validateStartEnabled();
  });
  nameField.addEventListener('input', validateStartEnabled);

  // ---------- ìˆ˜ë‹¨ë³„ UI/ê·œì¹™ ì „í™˜ ----------
  function applyInputRuleByChannel(){
    const isPASS = (loginSel.value === '3');
    telecomRow.style.display = isPASS ? 'block' : 'none';

    if (isPASS) {
      jLabel.textContent = 'ìƒë…„ì›”ì¼(8ìë¦¬)';
      birthOne.style.display = 'block';
      rrnWrap.style.display  = 'none';
      // ê°’ ì •ë¦¬
      birthOne.value = onlyDigits(birthOne.value).slice(0,8);
    } else {
      jLabel.textContent = 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ 13ìë¦¬';
      birthOne.style.display = 'none';
      rrnWrap.style.display  = 'flex';
      rrn1.value = onlyDigits(rrn1.value).slice(0,6);
      rrn2.value = onlyDigits(rrn2.value).slice(0,7);
    }
    validateStartEnabled();
  }
  loginSel.addEventListener('change', applyInputRuleByChannel);
  telecomSel.addEventListener('change', validateStartEnabled);
  applyInputRuleByChannel(); // ì´ˆê¸° 1íšŒ

  // ---------- ë²„íŠ¼ í™œì„±í™” ----------
  function validateStartEnabled(){
    const opt = loginSel.value;
    const isPASS = (opt === '3');
    const nameOk  = !!nameField.value.trim();
    const phoneOk = onlyDigits(phoneField.value).length >= 10;

    let jOk = false;
    if (isPASS) {
      jOk = (onlyDigits(birthOne.value).length === 8);
    } else {
      jOk = (onlyDigits(rrn1.value).length === 6) && (onlyDigits(rrn2.value).length === 7);
    }
    const telOk = !isPASS || !!telecomSel.value;
    btnStart.disabled = !(opt && nameOk && phoneOk && jOk && telOk);
  }

  // ---------- Step1: ê°„í¸ì¸ì¦ ì‹œì‘ ----------
   // ìƒíƒœí‘œì‹œ
  function setStatus(msg, kind) {
    const el = document.getElementById('nhisStatus');
    if (!el) return;
    el.textContent = msg || '';
    el.className = kind === 'err' ? 'text-red-600' : 'text-green-700';
  }

  let startPayloadCache = null; // ì¦‰ì‹œí˜•ì¼ ë•Œ completeì— ì¬ì‚¬ìš©
  let directReady = false;      // trueë©´ callbackId ì—†ì´ ë°”ë¡œ complete

  const btnStart    = document.getElementById('btnStart');
  const btnComplete = document.getElementById('btnComplete');

  btnStart.addEventListener('click', async () => {
    const loginOption = document.getElementById('loginOption').value;     // "0"~"7"
    const telecomSel  = document.getElementById('telecom');
    const telecom     = telecomSel ? telecomSel.value : '';
    const name        = document.getElementById('name').value.trim();
    const phone       = document.getElementById('phone').value.trim();
    const juminOrBirth= document.getElementById('juminOrBirth').value.trim();

    if (!loginOption) { alert('ê°„í¸ì¸ì¦ ìˆ˜ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.'); return; }
    if (loginOption === '3' && !telecom) { alert('í†µì‹ ì‚¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
    if (!name || !phone || !juminOrBirth) { alert('ì´ë¦„/íœ´ëŒ€í°/ìƒë…„ì›”ì¼(ë˜ëŠ” ì£¼ë¯¼ë²ˆí˜¸)ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

    setStatus('ê°„í¸ì¸ì¦ ìš”ì²­ ì¤‘...');
    directReady = false;
    startPayloadCache = {
      loginOption, telecom, userName: name, hpNumber: phone, juminOrBirth
    };

    try {
      const rsp = await fetch('/api/dh/simple/start', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(startPayloadCache)
      });
      const data = await rsp.json();
      console.log('[NHIS][start]', rsp.status, data);

      if (!rsp.ok) {
        setStatus('ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨', 'err');
        alert(data?.message || 'ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨');
        return;
      }

      // ğŸ¯ ë¶„ê¸° 1: ì½œë°±í˜•(0001 + callbackId)
      if ((data.errCode === '0001' || data.errCode === 1) && data?.data?.callbackId) {
        const cbid = data.data.callbackId;
        window.open(`https://datahub-dev.scraping.co.kr/auth/simple?callbackId=${cbid}`, '_blank');
        setStatus('ì¸ì¦ì°½ì´ ì—´ë ¸ìŠµë‹ˆë‹¤. ì¸ì¦ ì™„ë£Œ í›„ "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'ok');
        btnComplete.disabled = false;
        // complete ì‹œ body: { callbackId: cbid }ë¡œ ì „ì†¡ë¨ (ë°±ì—”ë“œì—ì„œ ê·¸ëŒ€ë¡œ ë°›ìŒ)
        btnComplete.dataset.callbackId = cbid;
        return;
      }

      // ğŸ¯ ë¶„ê¸° 2: ì¦‰ì‹œí˜•(0000) â†’ íŒì—… ì—†ì´ ê³§ë°”ë¡œ complete ê°€ëŠ¥
      if (data.errCode === '0000' || data.errCode === 0) {
        directReady = true;
        delete btnComplete.dataset.callbackId; // í˜¹ì‹œ ë‚¨ì•„ìˆë˜ ê°’ ì œê±°
        setStatus('ì¸ì¦ì°½ ì—†ì´ ì¦‰ì‹œ ì¡°íšŒ ê°€ëŠ¥í•©ë‹ˆë‹¤. "ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°"ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'ok');
        btnComplete.disabled = false;
        return;
      }

      // ê·¸ ì™¸ ì‹¤íŒ¨
      setStatus('ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨', 'err');
      alert(data?.message || 'ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨');
    } catch (e) {
      console.error(e);
      setStatus('ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨', 'err');
      alert('ê°„í¸ì¸ì¦ ì‹œì‘ ì‹¤íŒ¨');
    }
  });

  // â€œë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°â€ ë²„íŠ¼
  btnComplete.addEventListener('click', async () => {
    setStatus('ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì¤‘...');
    btnComplete.disabled = true;
    try {
      const cbid = btnComplete.dataset.callbackId || '';
      const body = directReady
        ? { direct: true, ...startPayloadCache } // ì¦‰ì‹œí˜•: ì‹œì‘ê³¼ ë™ì¼ í˜ì´ë¡œë“œë¡œ ì¬ì¡°íšŒ
        : { callbackId: cbid };                  // ì½œë°±í˜•: callbackIdë¡œ ì™„ë£Œ ì¡°íšŒ

      const rsp = await fetch('/api/dh/simple/complete', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
      });
      const data = await rsp.json();
      console.log('[NHIS][complete]', rsp.status, data);

      if (!rsp.ok || (data.errCode !== '0000' && data.errCode !== 0)) {
        setStatus('ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨', 'err');
        alert(data?.message || 'ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
        btnComplete.disabled = false;
        return;
      }

      // ì—¬ê¸°ì„œ data.data(í˜¹ì€ data.result)ì— ê²°ê³¼ê°€ ë“¤ì–´ì˜´.
      setStatus('ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì™„ë£Œ', 'ok');

      // ğŸ‘‰ í•„ìš”í•˜ë©´ ë¯¸ë¦¬ë³´ê¸° DOMì— data í‘œì‹œ or ë‹¤ìŒ í˜ì´ì§€ë¡œ ì´ë™
      // location.href = document.getElementById('nextUrl').value || '/info';
    } catch (e) {
      console.error(e);
      setStatus('ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨', 'err');
      alert('ê²€ì§„ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨');
      btnComplete.disabled = false;
    }
  });
</script>
</body>
</html>
