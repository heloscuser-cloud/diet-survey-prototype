<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “데이터 불러오기”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
	<option value="1">삼성패스</option>
	<option value="2">페이코</option>
            <option value="3">통신사</option>
	<option value="4">KB모바일인증서</option>
	<option value="5">네이버</option>
	<option value="6">신한인증서</option>
	<option value="7">토스</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label>통신사(PASS 선택 시)</label>
          <select id="telecom">
            <option value="" selected>-- 선택 --</option>
            <option value="1">SKT</option>
            <option value="2">KT</option>
            <option value="3">LGU+</option>
          </select>
        </div>
        <div>
          <label for="name">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
<div>
  <label id="jLabel">생년월일(8자리)</label>

  <!-- PASS(3)일 때 보이는 생년월일 1칸 -->
  <input id="birthOne" inputmode="numeric" placeholder="19900307" style="display:none">

  <!-- 그 외 수단일 때 보이는 주민등록번호 2칸 -->
  <div id="rrnWrap" class="row-inline" style="display:none">
    <input id="rrn1" inputmode="numeric" placeholder="######" maxlength="6" style="flex:1">
    <span>-</span>
    <input id="rrn2" inputmode="numeric" placeholder="#######" maxlength="7" style="flex:1">
  </div>
</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stack">
        <button type="button" id="btnStart" class="btn btn-primary" disabled>간편인증 시작</button>
        <button type="button" id="btnComplete" class="btn btn-secondary" disabled>인증 완료 후 데이터 불러오기</button>
      </div>
      <div id="status" class="status"></div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

    <div class="stack">
      <a id="btnSkip" class="btn btn-secondary" href="{{ next_url or '/info' }}">건너뛰고 계속</a>
      <a id="btnNext" class="btn btn-primary" href="{{ next_url or '/info' }}" aria-disabled="true" style="pointer-events:none;opacity:.5">다음(정보 입력으로)</a>
    </div>
  </div>
<script>
(function(){
  const $ = (s)=>document.querySelector(s);

  const loginSel   = $('#loginSel');
  const telecomSel = $('#telecomSel');
  const nameEl     = $('#name');
  const phoneEl    = $('#phone');
  const birthEl    = $('#birth');   // yyyyMMdd
  const juminEl    = $('#jumin');   // 13자리(또는 6-7 분할을 합쳐 서버로 13자리 전송)
  const btnStart   = $('#btnStart');
  const btnComplete= $('#btnComplete');
  const statusMsg  = $('#statusMsg');
  const nextUrl    = $('#nextUrl'); // ex) /info

  // UI 토글: PASS(3) ⇒ 통신사+생년월일 노출, 그 외 ⇒ 주민번호 노출
  function refreshFields(){
    const opt = loginSel.value;
    const isPASS = (opt === '3'); // 3=통신사 PASS
    $('#rowTelecom').style.display = isPASS ? '' : 'none';
    $('#rowBirth').style.display   = isPASS ? '' : 'none';
    $('#rowJumin').style.display   = isPASS ? 'none' : '';
    // 선택 강조(버튼처럼 보이게): select에선 생략
  }
  loginSel.addEventListener('change', refreshFields);
  refreshFields(); // 초기 1회

  function setStatus(msg, ok){
    statusMsg.textContent = msg || '';
    statusMsg.className = ok ? 'text-green-600' : 'text-red-600';
  }

  // 간편인증 시작
  btnStart.addEventListener('click', async () => {
    const loginOption = loginSel.value;
    const telecom     = telecomSel.value;
    const name        = (nameEl.value || '').trim();
    const phone       = (phoneEl.value || '').trim().replace(/[^0-9]/g,'');
    const birth       = (birthEl.value || '').trim(); // yyyyMMdd
    const jumin       = (juminEl.value || '').trim().replace(/[^0-9]/g,'');

    if(!loginOption){ alert('간편인증 수단을 선택하세요.'); return; }
    if(loginOption === '3'){ // PASS
      if(!telecom){ alert('통신사를 선택하세요.'); return; }
      if(!birth || birth.length !== 8){ alert('생년월일(8자리)을 입력하세요.'); return; }
    }else{
      if(!jumin || jumin.length !== 13){ alert('주민등록번호 13자리를 입력하세요.'); return; }
    }
    if(!name){ alert('이름을 입력하세요.'); return; }
    if(!phone || phone.length < 10){ alert('휴대폰 번호를 정확히 입력하세요.'); return; }

    // 서버에 넘길 신분계열값: PASS=생년월일, 그외=주민번호
    const juminOrBirth = (loginOption === '3') ? birth : jumin;

    setStatus('간편인증 요청 중...', true);
    btnStart.disabled = true;
    try{
      const rsp = await fetch('/api/dh/simple/start', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          loginOption,
          telecom,            // PASS 아닐 땐 서버에서 무시됨
          userName: name,
          hpNumber: phone,
          juminOrBirth        // 서버에서 암호화하여 전송
        })
      });

      const data = await rsp.json();
      if(!rsp.ok){
        console.warn('start failed', data);
        alert(data.detail || '간편인증 시작 실패');
        setStatus('간편인증 시작 실패', false);
        return;
      }

      // === 즉시성공(0000) 처리: 콜백 없이 바로 결과까지 끝난 케이스 ===
      if (String(data.errCode) === '0000' && data.data && data.data.immediate){
        // 서버가 세션에 최신건 저장까지 했으므로 바로 다음 화면
        setStatus('인증이 완료되었습니다. 다음 단계로 이동합니다.', true);
        window.location.href = nextUrl.value || '/info';
        return;
      }

      // === 콜백형(0001/0301 등) 처리: callbackId로 인증창 열고 완료 버튼 유도 ===
      const cbid = data && data.data && data.data.callbackId;
      if (cbid){
        window.open(`https://datahub-dev.scraping.co.kr/auth/simple?callbackId=${cbid}`, '_blank', 'noopener');
        setStatus('인증창이 열렸습니다. 인증 완료 후 "데이터 불러오기"를 누르세요.', true);
        btnComplete.disabled = false;
      }else{
        // 공급사에 따라 바로 callbackId가 안 올 수 있으므로 안내
        setStatus('인증 요청 완료. 인증을 진행한 뒤 "데이터 불러오기"를 눌러주세요.', true);
        btnComplete.disabled = false;
      }
    }catch(e){
      console.error(e);
      alert('간편인증 시작 중 오류가 발생했습니다.');
      setStatus('간편인증 시작 오류', false);
    }finally{
      btnStart.disabled = false;
    }
  });

  // 데이터 불러오기(콜백형에서 인증 완료 후)
  btnComplete.addEventListener('click', async () => {
    setStatus('데이터 수신 중...', true);
    btnComplete.disabled = true;
    try{
      const rsp = await fetch('/api/dh/simple/complete', { method:'POST' });
      const data = await rsp.json();
      if(!rsp.ok){
        console.warn('complete failed', data);
        alert(data.detail || '데이터 수신 실패');
        setStatus('데이터 수신 실패', false);
        return;
      }
      // 서버가 세션에 저장해두므로 바로 다음 페이지로
      setStatus('데이터 수신 완료. 다음 단계로 이동합니다.', true);
      window.location.href = nextUrl.value || '/info';
    }catch(e){
      console.error(e);
      alert('데이터 수신 중 오류가 발생했습니다.');
      setStatus('데이터 수신 오류', false);
    }finally{
      btnComplete.disabled = false;
    }
  });

})();
</script>


</body>
</html>
