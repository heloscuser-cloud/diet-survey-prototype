<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    #status strong { font-size: 1.05rem; color:#111; }
    #status .warn { color:#b91c1c; font-weight:600; }
    #status .ok { color:#16a34a; font-weight:600; }
    /* 라디오 + 텍스트 수평/수직 정렬 */
    .gender-wrap { display:flex; align-items:center; gap:20px; }
    .gender-wrap label { display:inline-flex; align-items:center; gap:6px; font-size:11pt; margin:0; }
    .gender-wrap input[type="radio"] { margin:0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “인증완료”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label style="font-size:12pt; font-weight:700;">간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
            <option value="1">삼성패스</option>
            <option value="2">페이코</option>
            <option value="3">통신사 PASS인증서</option>
            <option value="4">KB모바일인증서</option>
            <option value="5">네이버인증서</option>
            <option value="6">신한인증서</option>
            <option value="7">토스인증서</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label style="font-size:12pt; font-weight:700;">통신사(PASS 선택 시)</label>
          <select id="telecom" class="mt-1 w-full border rounded px-3 py-2" disabled>
            <option value="" selected>-- 통신사 선택 --</option>
            <option value="1">KT</option>
            <option value="2">SKT</option>
            <option value="3">LG</option>
            <option value="4">KT알뜰폰</option>
            <option value="5">SKT알뜰폰</option>
            <option value="6">LG알뜰폰</option>
          </select>
        </div>
        <div>
           <label for="name" style="font-size:12pt; font-weight:700;">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone" style="font-size:12pt; font-weight:700;">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
        <div>
          <label for="birth"
                id="jLabel"
                class="block text-sm font-medium"
                style="font-size:12pt; font-weight:700;">
            생년월일(8자리)
          </label>
          <input id="birth" type="text" inputmode="numeric" placeholder="YYYYMMDD" class="mt-1 w-full border rounded px-3 py-2" maxlength="8"/>
        </div>
          <div class="row-inline" style="align-items:center; gap:16px;">
            <label class="block text-sm font-medium" style="margin:0;">성별</label>
            <div class="gender-wrap" id="genderGroup" role="radiogroup" aria-label="성별" style="display:flex;gap:20px;">
              <label><input type="radio" name="gender" value="남"> <span>남</span></label>
              <label><input type="radio" name="gender" value="여"> <span>여</span></label>
            </div>
          </div>
      </div>
    </div>

    <input type="hidden" id="nextUrl" value="{{ next_url or '/info' }}">

    <div class="card">
      <div class="mt-4 flex items-center gap-3">
        <button id="btnStart" type="button"
                class="px-5 py-3 rounded-full bg-black text-white text-base font-bold">
          간편인증 시작
        </button>
        <button id="btnComplete" type="button"
                class="px-5 py-3 rounded-full border text-base font-bold"
                disabled>
          인증완료
        </button>
      </div>
      <div id="status"
          class="status"
          style="margin-top:12px; font-size:12pt; font-weight:700;">
      </div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);

  // 요소들
  const loginSel   = $('#loginOption');
  const telecomRow = $('#telecomRow');
  const telecomSel = $('#telecom');
  const nameEl     = $('#name');
  const phoneEl    = $('#phone');
  const birthEl    = $('#birth');
  const genderRadios = document.getElementsByName('gender');

  const btnStart     = document.getElementById('btnStart');
  const btnComplete  = document.getElementById('btnComplete');
  const statusEl     = document.getElementById('status');
  const nextUrlEl    = document.getElementById('nextUrl');

  let gStartDone  = false;
  let callbackId  = '';

  function setStatus(text, cls) {
    statusEl.className = 'status' + (cls ? ' ' + cls : '');
    statusEl.textContent = text || '';
  }
  const onlyDigits = v => (v||'').replace(/[^0-9]/g, '');

  function selectedGender(){
    for (const r of genderRadios){ if (r.checked) return r.value; }
    return '';
  }

  function applyInputRule(){
    const isPASS = (loginSel.value === '3');
    telecomRow.style.display = isPASS ? 'block' : 'none';
    if (telecomSel) {
      if (isPASS) telecomSel.disabled = false;
      else { telecomSel.value = ''; telecomSel.disabled = true; }
    }
    validateStartEnabled();
  }

  function validateStartEnabled(){
    const opt     = loginSel?.value || '';
    const isPASS  = (opt === '3');
    const nameOk  = !!(nameEl?.value || '').trim();
    const phoneOk = onlyDigits(phoneEl?.value).length >= 9;
    const birthOk = onlyDigits(birthEl?.value).length === 8;
    const genderOk= !!selectedGender();
    const telOk   = !isPASS || !!(telecomSel?.value || '');
    btnStart.disabled = !(opt && nameOk && phoneOk && birthOk && genderOk && telOk);
  }

  loginSel?.addEventListener('change', applyInputRule);
  telecomSel?.addEventListener('change', validateStartEnabled);
  nameEl?.addEventListener('input', validateStartEnabled);
  phoneEl?.addEventListener('input', (e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,11); validateStartEnabled(); });
  birthEl?.addEventListener('input', ()=>{ validateStartEnabled(); });
  for (const r of genderRadios){ r.addEventListener('change', validateStartEnabled); }
  applyInputRule();

  // 간편인증 시작
  btnStart.addEventListener('click', async () => {
    if (gStartDone) return;

    const loginOption = loginSel.value.trim();
    const telecomRaw  = (telecomSel?.value || '').trim();
    const telecom     = (loginOption === '3') ? telecomRaw : '';
    const name        = nameEl.value.trim();
    const phone       = onlyDigits(phoneEl.value).slice(0,11);
    const birth       = onlyDigits(birthEl.value).slice(0,8);
    const gender      = selectedGender();

    if (!gender){ alert('성별을 입력해주세요.'); return; }

    setStatus('간편인증 요청 전송 중...');
    btnStart.disabled = true;

    try {
      const rsp = await fetch('/api/dh/simple/start', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ loginOption, telecom, userName: name, hpNumber: phone, birth, gender })
      });
      const data = await rsp.json();
      console.log('[DH][start]', rsp.status, data);

      if (rsp.ok && data.errCode === "0001" && data.data?.callbackId) {
        callbackId = data.data.callbackId;
        gStartDone = true;
        setStatus('간편인증 요청 전송 성공. 스마트폰에서 인증 완료 후 "인증완료"를 누르세요.', 'ok');
        btnComplete.disabled = false;
        return;
      }
      btnStart.disabled = false;
      gStartDone = false;
      alert('간편인증 시작 실패: ' + (data.message || data.errCode || '오류'));
      setStatus('간편인증 시작 실패', 'err');
    } catch (e) {
      console.error(e);
      btnStart.disabled = false;
      gStartDone = false;
      setStatus('간편인증 시작 실패(네트워크)', 'err');
    }
  });

  // 인증완료(수동)
  btnComplete.addEventListener('click', async () => {
    if (!gStartDone) { alert('먼저 "간편인증 시작"을 진행해주세요.'); return; }
    setStatus('인증 완료 확인 중...');
    btnComplete.disabled = true;

    async function tryCompleteOnce() {
      const rsp = await fetch('/api/dh/simple/complete?all=1', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(callbackId ? { callbackId } : {}),
        credentials: 'include'
      });
      const data = await rsp.json().catch(()=> ({}));
      console.log('[COMPLETE][rsp]', rsp.status, data);

      if (rsp.status === 200 && data && data.ok) {
        setStatus('인증 및 데이터 수집 완료! 다음 단계로 이동합니다.', 'ok');
        window.location.href = (nextUrlEl.value || '/info');
        return true;
      }
      if (rsp.status === 202) {
        setStatus('인증완료 확인 중... 잠시만 기다려주세요.');
        return false;
      }
      alert(data && data.msg ? data.msg : '인증 확인 중 오류가 발생했습니다.');
      setStatus('오류가 발생했습니다. 다시 시도해 주세요.', 'err');
      return null;
    }

    const deadline = Date.now() + 60000;
    while (Date.now() < deadline) {
      const r = await tryCompleteOnce();
      if (r === true) return;
      if (r === null) break;
      await new Promise(res => setTimeout(res, 2000));
    }

    alert('아직 인증이 완료되지 않았습니다. 휴대폰에서 인증을 완료한 뒤 다시 "인증완료"를 눌러주세요.');
    setStatus('인증 대기 상태입니다. 인증 완료 후 다시 "인증완료"를 눌러주세요.', 'warn');
    btnComplete.disabled = false;
  });

  validateStartEnabled();
})();
</script>
</body>
</html>
