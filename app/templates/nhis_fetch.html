<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .w-year{width:9ch} .w-mm,.w-dd{width:5.5ch}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “데이터 불러오기”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
            <option value="PASS">통신사 PASS</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label>통신사(PASS 선택 시)</label>
          <select id="telecom">
            <option value="" selected>-- 선택 --</option>
            <option value="SKT">SKT</option>
            <option value="KT">KT</option>
            <option value="LGU">LGU</option>
          </select>
        </div>
        <div>
          <label for="name">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
        <div>
          <label>생년월일(YYYYMMDD) 또는 주민번호(13자리)</label>
          <div class="row-inline">
            <input id="juminOrBirth" inputmode="numeric" placeholder="19900307 또는 9010101234567">
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stack">
        <button type="button" id="btnStart" class="btn btn-primary" disabled>간편인증 시작</button>
        <button type="button" id="btnComplete" class="btn btn-secondary" disabled>인증 완료 후 데이터 불러오기</button>
      </div>
      <div id="status" class="status"></div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

    <div class="stack">
      <a id="btnSkip" class="btn btn-secondary" href="{{ next_url or '/info' }}">건너뛰고 계속</a>
      <a id="btnNext" class="btn btn-primary" href="{{ next_url or '/info' }}" aria-disabled="true" style="pointer-events:none;opacity:.5">다음(정보 입력으로)</a>
    </div>
  </div>

  <script>
  (function(){
    const $ = (s)=>document.querySelector(s);
    const setStatus=(m,k)=>{ const el=$('#status'); el.textContent=m||''; el.className='status'+(k?(' '+k):''); };
    const onlyDigits = v => (v||'').replace(/[^0-9]/g,'');

    // 입력 보정
    $('#phone').addEventListener('input', e=> e.target.value = onlyDigits(e.target.value).slice(0,11));
    $('#juminOrBirth').addEventListener('input', e=> e.target.value = onlyDigits(e.target.value).slice(0,13));

    // 로그인 옵션/통신사
    let callbackId = null;
    const loginSel = $('#loginOption');
    const telecomRow = $('#telecomRow');
    const telecomSel = $('#telecom');
    const btnStart = $('#btnStart');
    const btnComplete = $('#btnComplete');
    const btnNext = $('#btnNext');
    const preview = $('#preview');

    loginSel.addEventListener('change', ()=>{
      const v = loginSel.value;
      telecomRow.style.display = (v==='PASS') ? 'block' : 'none';
      btnStart.disabled = (v === '');
    });

    // Step1: 간편인증 시작
    btnStart.addEventListener('click', async ()=>{
      const loginOption = loginSel.value;
      const telecom = telecomSel.value;
      const name = $('#name').value.trim();
      const phone = $('#phone').value.trim();
      const jb = $('#juminOrBirth').value.trim();

      if(!loginOption){ alert('간편인증 수단을 선택하세요.'); return; }
      if(loginOption==='PASS' && !telecom){ alert('통신사를 선택하세요.'); return; }
      if(!name || !phone || !jb){ alert('이름/휴대폰/생년월일(또는 주민번호)을 입력하세요.'); return; }

      setStatus('간편인증 요청 중...');
      try{
        const rsp = await fetch('/api/dh/simple/start', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({
            loginOption, telecom,
            userName: name, hpNumber: phone, juminOrBirth: jb
          })
        });
        const data = await rsp.json();
        if(!rsp.ok || (data.result && data.result!=='FAIL' && data.errCode && data.errCode!=='0001')){
          // 공급사 응답 포맷 다양성 대비
          console.warn('start raw:', data);
        }
        // 문서 예: FAIL + errCode 0001 와 함께 callbackId 제공(사용자 인증 진행)
        callbackId = (data.data && data.data.callbackId) || null;
        if(callbackId){
          setStatus('휴대폰에서 인증을 완료한 뒤, "데이터 불러오기"를 눌러주세요.', 'ok');
          btnComplete.disabled = false;
        }else{
          setStatus('간편인증을 시작했습니다. 잠시 후 "데이터 불러오기"를 눌러주세요.', 'ok');
          btnComplete.disabled = false;
        }
      }catch(e){
        console.error(e);
        setStatus('간편인증 시작 실패', 'err');
        alert('간편인증 시작에 실패했습니다.');
      }
    });

    // Step2: 완료(captcha)
    btnComplete.addEventListener('click', async ()=>{
      if(!callbackId){ alert('callbackId가 없습니다. Step1을 먼저 수행하세요.'); return; }
      setStatus('검진 데이터 불러오는 중...');
      try{
        const rsp = await fetch('/api/dh/simple/complete', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ callbackId, callbackType: 'SIMPLE' })
        });
        const data = await rsp.json();
        if(!rsp.ok){ throw new Error('complete failed'); }

        // 미리보기(가능하면 최신 일반검진 1건)
        const list = (data.data && data.data.CHECKUPLIST) || [];
        const general = list.filter(x=> (x.CHECKUPKIND||'')==='일반')
                            .sort((a,b)=> String(b.CHECKUPDATE||'').localeCompare(String(a.CHECKUPDATE||'')));
        const latest = general[0];
        preview.style.display = 'block';
        preview.innerHTML = latest ? `
          <div><b>검진일자</b> ${latest.CHECKUPDATE||'-'}</div>
          <div><b>검진종류</b> ${latest.CHECKUPKIND||'-'}</div>
          <div><b>검진기관</b> ${latest.CHECKUPORGAN||'-'}</div>
          <div class="muted" style="margin-top:6px">상세항목은 제출 후 관리자에서 확인</div>
        ` : `<div>최근 10년 일반검진 데이터가 없거나 조회되지 않았습니다.</div>`;

        setStatus('건강검진 데이터 연결 완료', 'ok');
        btnNext.style.pointerEvents = 'auto';
        btnNext.style.opacity = '1';
        btnNext.setAttribute('aria-disabled','false');
      }catch(e){
        console.error(e);
        setStatus('불러오기 실패', 'err');
        alert('불러오기에 실패했습니다. 인증 완료 여부를 확인한 뒤 다시 시도해 주세요.');
      }
    });
  })();
  </script>
</body>
</html>
