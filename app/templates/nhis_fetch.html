<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  #status strong { font-size: 1.05rem; color:#111; }
  #status .warn { color:#b91c1c; font-weight:600; }
  #status .ok { color:#16a34a; font-weight:600; }
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “데이터 불러오기”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
	<option value="1">삼성패스</option>
	<option value="2">페이코</option>
            <option value="3">통신사</option>
	<option value="4">KB모바일인증서</option>
	<option value="5">네이버</option>
	<option value="6">신한인증서</option>
	<option value="7">토스</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label>통신사(PASS 선택 시)</label>
          <select id="telecom">
            <option value="" selected>-- 선택 --</option>
            <option value="1">SKT</option>
            <option value="2">KT</option>
            <option value="3">LGU+</option>
          </select>
        </div>
        <div>
          <label for="name">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
<div>
  <label id="jLabel">생년월일(8자리)</label>

  <!-- PASS(3)일 때 보이는 생년월일 1칸 -->
  <input id="birthOne" inputmode="numeric" placeholder="19900307" style="display:none">

  <!-- 그 외 수단일 때 보이는 주민등록번호 2칸 -->
  <div id="rrnWrap" class="row-inline" style="display:none">
    <input id="rrn1" inputmode="numeric" placeholder="######" maxlength="6" style="flex:1">
    <span>-</span>
    <input id="rrn2" inputmode="numeric" placeholder="#######" maxlength="7" style="flex:1">
  </div>
</div>
        </div>
      </div>
    </div>

<input type="hidden" id="nextUrl" value="{{ next_url or '/info' }}">

    <div class="card">
<div class="mt-4 flex items-center gap-3">
  <button id="btnStart" type="button" class="px-4 py-2 rounded bg-black text-white">
    간편인증 시작
  </button>
  <button id="btnComplete" type="button" class="px-4 py-2 rounded border" disabled>
    인증완료
  </button>
</div>
      <div id="status" class="status"></div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

<!-- 안내/상태 메시지 (강조 스타일 포함) -->
<p id="status" class="mt-3 text-sm text-gray-600"></p>

<!-- 다음 페이지 경로 (필요 시 템플릿에서 주입) -->
<input type="hidden" id="nextUrl" value="{{ next_url or '/info' }}">

<script>
(function(){
  const $ = (s)=>document.querySelector(s);

  // ---- DOM refs (현 파일의 id에 맞춤) ----
  const loginSel    = $('#loginOption');   // 인증수단
  const telecomRow  = $('#telecomRow');    // 통신사 행 전체
  const telecomSel  = $('#telecom');       // 통신사 콤보
  const nameEl      = $('#name');          // 이름
  const phoneEl     = $('#phone');         // 휴대폰번호

  const jLabel      = $('#jLabel');        // 라벨: 생년월일/주민번호 문구 바꿈
  const birthOne    = $('#birthOne');      // PASS(3)일 때 8자리 생년월일
  const rrnWrap     = $('#rrnWrap');       // 그 외 주민번호 6-7칸 묶음
  const rrn1        = $('#rrn1');          // 주민번호 앞 6
  const rrn2        = $('#rrn2');          // 주민번호 뒤 7

  const btnStart    = $('#btnStart');      // 간편인증 시작
  const btnComplete = $('#btnComplete');   // 인증완료 (수동 트리거)
  const statusEl    = $('#status');        // 상태 메시지
  const nextInput   = $('#nextUrl');       // 다음 경로(/info)

  const onlyDigits = v => (v||'').replace(/[^0-9]/g, '');
  const setStatus = (html, kind)=> {
    statusEl.innerHTML = html || '';
    statusEl.className = 'mt-3 text-sm ' + (kind==='err' ? 'warn' : 'ok');
  };

  // ---- 입력 UI 토글 ----
  function applyInputRuleByChannel(){
    const isPASS = (loginSel.value === '3'); // 3=통신사 PASS
    telecomRow.style.display = isPASS ? 'block' : 'none';

    if (!loginSel.value) {
      birthOne.style.display = 'none';
      rrnWrap.style.display  = 'none';
      jLabel.textContent = '식별값';
    } else if (isPASS) {
      jLabel.textContent = '생년월일(8자리)';
      birthOne.style.display = 'block';
      rrnWrap.style.display  = 'none';
      birthOne.value = onlyDigits(birthOne.value).slice(0,8);
    } else {
      jLabel.textContent = '주민등록번호 13자리';
      birthOne.style.display = 'none';
      rrnWrap.style.display  = 'flex';
      rrn1.value = onlyDigits(rrn1.value).slice(0,6);
      rrn2.value = onlyDigits(rrn2.value).slice(0,7);
    }
    validateStartEnabled();
  }
  loginSel.addEventListener('change', applyInputRuleByChannel);
  telecomSel.addEventListener('change', validateStartEnabled);
  nameEl.addEventListener('input', validateStartEnabled);
  phoneEl.addEventListener('input', (e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,11); validateStartEnabled(); });
  birthOne.addEventListener('input', (e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,8);  validateStartEnabled(); });
  rrn1.addEventListener('input', (e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,6);  validateStartEnabled(); });
  rrn2.addEventListener('input', (e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,7);  validateStartEnabled(); });

  function validateStartEnabled(){
    const opt    = loginSel.value;
    const isPASS = (opt === '3');
    const nameOk  = !!nameEl.value.trim();
    const phoneOk = onlyDigits(phoneEl.value).length >= 10;

    let jOk = false;
    if (isPASS) jOk = (onlyDigits(birthOne.value).length === 8);
    else if (opt) jOk = (onlyDigits(rrn1.value).length === 6) && (onlyDigits(rrn2.value).length === 7);

    const telOk = !isPASS || !!telecomSel.value;
    btnStart.disabled = !(opt && nameOk && phoneOk && jOk && telOk);
  }
  applyInputRuleByChannel(); // 초기 1회

  // ---- 상태 저장(콜백ID/즉시형 여부) ----
  let callbackId = '';       // 콜백형이면 채워짐
  let canDirect  = false;    // 즉시형(0000)인 경우 true

  // ---- 간편인증 시작 ----
  btnStart.addEventListener('click', async (ev)=>{
    ev.preventDefault(); ev.stopPropagation();

    const loginOption  = loginSel.value;
    const telecom      = telecomSel ? telecomSel.value : '';
    const name         = (nameEl.value||'').trim();
    const phone        = onlyDigits(phoneEl.value);
    const isPASS       = (loginOption === '3');
    const juminOrBirth = isPASS ? onlyDigits(birthOne.value) : (onlyDigits(rrn1.value)+onlyDigits(rrn2.value));
    const nextUrl      = nextInput?.value || '/info';

    // 전송
    try{
      const rsp = await fetch('/api/dh/simple/start', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ loginOption, telecom, userName:name, hpNumber:phone, juminOrBirth })
      });
      const data = await rsp.json();

      if (!rsp.ok) {
        setStatus('<span class="warn">간편인증 요청 실패:</span> ' + (data?.message || '다시 시도해 주세요.'), 'err');
        btnComplete.disabled = true;
        return;
      }

      // 성공적으로 요청됨 → 사용자에게 "휴대폰에서 인증 완료 후 [인증완료] 버튼" 강조
      callbackId = (data && data.data && data.data.callbackId) || '';
      canDirect  = !!(String(data.errCode)==='0000' || String(data.errCode)==='0' || (data.data && data.data.immediate));

      btnComplete.disabled = false;
      setStatus('<strong>간편인증 요청 전송 성공.</strong><br>스마트폰에서 간편인증을 <b>완료</b>하신 후 <b>오른쪽의 <u>인증완료</u> 버튼</b>을 눌러주세요.', 'ok');

    }catch(e){
      console.error(e);
      setStatus('<span class="warn">간편인증 요청 중 오류가 발생했습니다.</span>', 'err');
      btnComplete.disabled = true;
    }
  });

  // ---- 인증완료 (수동 트리거) ----
  btnComplete.addEventListener('click', async (ev)=>{
    ev.preventDefault(); ev.stopPropagation();
    btnComplete.disabled = true;

    try{
      // 콜백형이면 callbackId, 아니면 즉시형(또는 콜백ID 미제공)으로 direct 조회
      const body = callbackId ? { callbackId } : { direct:true };
      const rsp = await fetch('/api/dh/simple/complete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      const data = await rsp.json();

      if (rsp.ok && (String(data.errCode)==='0000' || String(data.errCode)==='0')) {
        // 서버가 nhis_latest 세션 저장 완료 → 다음 페이지로
        setStatus('<strong>국가검진 데이터 조회가 완료되었습니다.</strong> 곧 다음 단계로 이동합니다.', 'ok');
        location.href = nextInput?.value || '/info';
        return;
      }

      // 준비 전(202) 또는 실패 → 안내 후 /nhis 새로고침
      alert('간편인증이 완료되지 않았습니다. 스마트폰에서 인증을 완료하신 후 [인증완료] 버튼을 다시 눌러주세요.');
      location.href = '/nhis';
    }catch(e){
      console.error(e);
      alert('오류가 발생했습니다. 다시 시도해 주세요.');
      location.href = '/nhis';
    }
  });

})();
</script>

</body>
</html>
