<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “데이터 불러오기”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label>간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
	<option value="1">삼성패스</option>
	<option value="2">페이코</option>
            <option value="3">통신사</option>
	<option value="4">KB모바일인증서</option>
	<option value="5">네이버</option>
	<option value="6">신한인증서</option>
	<option value="7">토스</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label>통신사(PASS 선택 시)</label>
          <select id="telecom">
            <option value="" selected>-- 선택 --</option>
            <option value="1">SKT</option>
            <option value="2">KT</option>
            <option value="3">LGU+</option>
          </select>
        </div>
        <div>
          <label for="name">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
<div>
  <label id="jLabel">생년월일(8자리)</label>

  <!-- PASS(3)일 때 보이는 생년월일 1칸 -->
  <input id="birthOne" inputmode="numeric" placeholder="19900307" style="display:none">

  <!-- 그 외 수단일 때 보이는 주민등록번호 2칸 -->
  <div id="rrnWrap" class="row-inline" style="display:none">
    <input id="rrn1" inputmode="numeric" placeholder="######" maxlength="6" style="flex:1">
    <span>-</span>
    <input id="rrn2" inputmode="numeric" placeholder="#######" maxlength="7" style="flex:1">
  </div>
</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="stack">
        <button type="button" id="btnStart" class="btn btn-primary" disabled>간편인증 시작</button>
        <button type="button" id="btnComplete" class="btn btn-secondary" disabled>인증 완료 후 데이터 불러오기</button>
      </div>
      <div id="status" class="status"></div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>

    <div class="stack">
      <a id="btnSkip" class="btn btn-secondary" href="{{ next_url or '/info' }}">건너뛰고 계속</a>
      <a id="btnNext" class="btn btn-primary" href="{{ next_url or '/info' }}" aria-disabled="true" style="pointer-events:none;opacity:.5">다음(정보 입력으로)</a>
    </div>
  </div>

<script>
(function(){
  // ---------- 유틸 ----------
  const $ = (s)=>document.querySelector(s);
  const onlyDigits = v => (v||"").replace(/[^0-9]/g,'');

  const setStatus=(m,k)=>{
    const el=$('#status');
    el.textContent=m||'';
    el.className='status'+(k?(' '+k):'');
  };

  // ---------- DOM ----------
  const loginSel   = $('#loginOption');
  const telecomRow = $('#telecomRow');
  const telecomSel = $('#telecom');
  const nameField  = $('#name');
  const phoneField = $('#phone');

  const jLabel   = $('#jLabel');
  const birthOne = $('#birthOne'); // PASS(3) 전용
  const rrnWrap  = $('#rrnWrap');  // 기타 수단 전용
  const rrn1     = $('#rrn1');
  const rrn2     = $('#rrn2');

  const btnStart    = $('#btnStart');
  const btnComplete = $('#btnComplete');
  const btnNext     = $('#btnNext');
  const preview     = $('#preview');

  // 서버에서 내려주는 AUTH 베이스 (main.py에서 datahub_auth_base 전달)
  const AUTH_BASE = "{{ datahub_auth_base }}/auth/simple";

  let callbackId = null;

  // ---------- 입력 필터 ----------
  phoneField.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,11);
    validateStartEnabled();
  });
  birthOne.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,8);
    validateStartEnabled();
  });
  rrn1.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,6);
    validateStartEnabled();
  });
  rrn2.addEventListener('input', e=>{
    e.target.value = onlyDigits(e.target.value).slice(0,7);
    validateStartEnabled();
  });
  nameField.addEventListener('input', validateStartEnabled);

  // ---------- 수단별 UI/규칙 전환 ----------
  function applyInputRuleByChannel(){
    const isPASS = (loginSel.value === '3');
    telecomRow.style.display = isPASS ? 'block' : 'none';

    if (isPASS) {
      jLabel.textContent = '생년월일(8자리)';
      birthOne.style.display = 'block';
      rrnWrap.style.display  = 'none';
      // 값 정리
      birthOne.value = onlyDigits(birthOne.value).slice(0,8);
    } else {
      jLabel.textContent = '주민등록번호 13자리';
      birthOne.style.display = 'none';
      rrnWrap.style.display  = 'flex';
      rrn1.value = onlyDigits(rrn1.value).slice(0,6);
      rrn2.value = onlyDigits(rrn2.value).slice(0,7);
    }
    validateStartEnabled();
  }
  loginSel.addEventListener('change', applyInputRuleByChannel);
  telecomSel.addEventListener('change', validateStartEnabled);
  applyInputRuleByChannel(); // 초기 1회

  // ---------- 버튼 활성화 ----------
  function validateStartEnabled(){
    const opt = loginSel.value;
    const isPASS = (opt === '3');
    const nameOk  = !!nameField.value.trim();
    const phoneOk = onlyDigits(phoneField.value).length >= 10;

    let jOk = false;
    if (isPASS) {
      jOk = (onlyDigits(birthOne.value).length === 8);
    } else {
      jOk = (onlyDigits(rrn1.value).length === 6) && (onlyDigits(rrn2.value).length === 7);
    }
    const telOk = !isPASS || !!telecomSel.value;
    btnStart.disabled = !(opt && nameOk && phoneOk && jOk && telOk);
  }

  // ---------- Step1: 간편인증 시작 ----------
  btnStart.addEventListener('click', async ()=>{
    const loginOption = loginSel.value;          // "0"~"7"
    const telecom     = telecomSel.value;        // "1"/"2"/"3" (옵션)
    const name  = nameField.value.trim();
    const phone = onlyDigits(phoneField.value);

    const isPASS = (loginOption === '3');
    const juminOrBirth = isPASS
      ? onlyDigits(birthOne.value) // 8자리
      : (onlyDigits(rrn1.value)+onlyDigits(rrn2.value)); // 13자리

    if(!loginOption){ alert('간편인증 수단을 선택하세요.'); return; }
    if(isPASS && !telecom){ alert('통신사를 선택하세요.'); return; }
    if(!name || !phone || !juminOrBirth){ alert('이름/휴대폰/식별값을 입력하세요.'); return; }

    setStatus('간편인증 요청 중...');
    try{
      const rsp = await fetch('/api/dh/simple/start', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ loginOption, telecom, userName: name, hpNumber: phone, juminOrBirth })
      });
      const data = await rsp.json();
      console.log('[NHIS] start rsp', rsp.status, data);

      if(!rsp.ok){
        setStatus('간편인증 시작 실패', 'err');
        alert('간편인증 시작에 실패했습니다.');
        return;
      }

      callbackId = (data && data.data && data.data.callbackId) || null;

      if (callbackId){
        const url = `${AUTH_BASE}?callbackId=${encodeURIComponent(callbackId)}`;
        const win = window.open(url, '_blank', 'noopener'); // 팝업 시도
        if (!win) { location.href = url; return; }          // 차단 시 동일 탭
        alert('간편인증 창이 열렸습니다. 인증 완료 후 이 창으로 돌아와 "데이터 불러오기"를 눌러주세요.');
        btnComplete.disabled = false;
        setStatus('휴대폰에서 인증을 완료한 뒤, "데이터 불러오기"를 눌러주세요.', 'ok');
      } else {
        // callbackId가 없으면 UI를 띄울 방법이 없음 → 에러 표시
        setStatus('간편인증 시작 응답에 callbackId가 없습니다.', 'err');
        alert('간편인증 시작 응답이 올바르지 않습니다. 잠시 후 다시 시도해 주세요.');
      }
    }catch(e){
      console.error(e);
      setStatus('간편인증 시작 실패', 'err');
      alert('간편인증 시작에 실패했습니다.');
    }
  });

  // ---------- Step2: 완료(captcha) → 미리보기 ----------
  btnComplete.addEventListener('click', async ()=>{
    if(!callbackId){ alert('callbackId가 없습니다. Step1을 먼저 수행하세요.'); return; }
    setStatus('검진 데이터 불러오는 중...');
    try{
      const rsp = await fetch('/api/dh/simple/complete', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ callbackId, callbackType: 'SIMPLE' })
      });
      const data = await rsp.json();
      console.log('[NHIS] complete data', data);

      if(!rsp.ok){
        setStatus('불러오기 실패', 'err');
        alert('불러오기에 실패했습니다. 다시 시도해 주세요.');
        return;
      }

      const list = (data && data.data && (data.data.INCOMELIST || data.data.CHECKUPLIST)) || [];
      let latest = null;
      if (list.length){
        latest = list
          .map(r=>{
            const y = String(r.GUNYEAR||'').trim();
            const md = String(r.GUNDATE||'').trim();
            const [mm,dd] = (md.includes('/') ? md.split('/') : ['01','01']);
            return { raw:r, key:(y.length===4? (y+mm.padStart(2,'0')+dd.padStart(2,'0')) : '') };
          })
          .sort((a,b)=> b.key.localeCompare(a.key))[0];
      }

      preview.style.display='block';
      const exam = latest ? ((latest.raw.GUNYEAR||'') + '-' + String(latest.raw.GUNDATE||'').replace('/','-')) : '-';
      const raw = JSON.stringify(data, null, 2);

      preview.innerHTML = `
        <div><b>검진 연/일자</b> ${exam}</div>
        <details style="margin-top:8px">
          <summary>원본 응답(JSON) 보기</summary>
          <pre style="white-space:pre-wrap;font-size:12px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:10px;max-height:280px;overflow:auto;">${raw}</pre>
        </details>
      `;

      setStatus('건강검진 데이터 연결 완료', 'ok');
      btnNext.style.pointerEvents = 'auto';
      btnNext.style.opacity = '1';
      btnNext.setAttribute('aria-disabled','false');
    }catch(e){
      console.error(e);
      setStatus('불러오기 실패', 'err');
      alert('불러오기에 실패했습니다. 인증 완료 여부를 확인한 뒤 다시 시도해 주세요.');
    }
  });
})();
</script>
</body>
</html>
