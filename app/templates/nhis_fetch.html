<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
  <title>국가건강검진 데이터 조회</title>
  <style>
    :root { --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#64748b; --pri:#2563eb; --ok:#10b981; --err:#ef4444;}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}
    .container{max-width:720px;margin:0 auto;padding:20px;}
    h1{font-size:20px;margin:6px 0 12px;}
    p.muted{color:var(--muted);font-size:14px;margin:4px 0 16px;}
    .card{background:var(--card);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.05);padding:16px;margin-bottom:14px}
    .row{display:flex;flex-direction:column;gap:10px;}
    .row-inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:14px;color:#1f2937;}
    input,select{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:10px;font-size:16px;box-sizing:border-box}
    input::placeholder{color:#9ca3af}
    .btn{appearance:none;border:0;border-radius:12px;padding:12px 16px;font-weight:600;font-size:16px;cursor:pointer;user-select:none}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn-primary{background:var(--pri);color:#fff}
    .btn-secondary{background:#eef2ff;color:#1e293b;border:1px solid #e5e7eb}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .stack .btn{flex:1}
    .preview{background:#eef2ff;border-radius:12px;padding:10px;margin-top:8px}
    .status{font-size:14px;margin-top:8px}
    .status.ok{color:var(--ok)} .status.err{color:var(--err)}
    #status strong { font-size: 1.05rem; color:#111; }
    #status .warn { color:#b91c1c; font-weight:600; }
    #status .ok { color:#16a34a; font-weight:600; }
      .mt-6 { margin-top: 16px; }
    /* 라디오 + 텍스트 수평/수직 정렬 */
    .gender-wrap { display:flex; align-items:center; gap:20px; }
    .gender-wrap label { display:inline-flex; align-items:center; gap:6px; font-size:11pt; margin:0; }
    .gender-wrap input[type="radio"] { margin:0; }
        /* 간편인증 버튼 전용 스타일 (크게 + 둥글게 + 굵게) */
    .big-round-btn {
      padding: 14px 22px;           /* 기존보다 조금 더 크게 */
      border-radius: 9999px;        /* 완전 둥근 알약 모양 */
      font-size: 16px;              /* text-base 정도 */
      font-weight: 700;             /* 굵게 */
      border: 1px solid transparent;
      cursor: pointer;
      user-select: none;
    }
    .big-round-btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }
    .big-round-btn-primary {
      background: #000000;
      color: #ffffff;
    }
    .big-round-btn-outline {
      background: #ffffff;
      color: #111827;               /* 진한 회색 */
      border-color: #e5e7eb;        /* 엷은 회색 테두리 */
    }
  /* 동의 영역 전체 박스 */
  .consent-box {
    background-color: #ffffff;
    /* 테두리는 빼고, 둥근 흰 카드 느낌만 살림 */
    border-radius: 16px;
    padding: 12px 16px;
    font-size: 0.9rem;
    margin: 8px 0 18px;  /* 위·아래 간격: 위 카드/아래 버튼과 여유 있게 */
  }

  .consent-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px 16px;
    margin-top: 8px;
    align-items: center;
  }

  .consent-row-top {
    justify-content: flex-start;
    margin-top: 0;
    margin-bottom: 4px;
  }

  .consent-col {
    flex: 1 1 160px; /* 모바일에서는 1열, 넓은 화면에서는 2열 */
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .consent-label {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .consent-label-text {
    font-weight: 600;
  }

  .consent-required {
    color: #e11d48; /* Tailwind의 red-500 비슷한 느낌 */
    font-size: 0.8em;
    margin-left: 2px;
  }

  /* 동그란 체크박스 스타일 */
  .consent-check {
    appearance: none;
    -webkit-appearance: none;
    width: 13px;          /* 18px → 13px 정도로 줄임 (약 70%) */
    height: 13px;
    border-radius: 999px;
    border: 2px solid #c4c4c4;
    background-color: #ffffff;
    display: inline-block;
    position: relative;
    cursor: pointer;
    vertical-align: middle;
  }

  .consent-check:checked {
    border-color: #111111;
    background-color: #111111;
  }

  .consent-check:checked::after {
    content: '';
    position: absolute;
    left: 3px;
    top: 2px;
    width: 4px;
    height: 7px;
    border: 2px solid #ffffff;
    border-top: none;
    border-left: none;
    transform: rotate(45deg);
  }



  /* 보기 버튼 스타일 (모바일스럽게 둥글게) */
  .consent-view-btn {
    flex-shrink: 0;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid #d4d4d8;
    background-color: #f9fafb;
    font-size: 0.75rem;
    cursor: pointer;
    white-space: nowrap;
  }

  .consent-view-btn:hover {
    background-color: #e5e7eb;
  }

  /* 동의서 모달 오버레이 */
  .consent-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    display: none;        /* 기본은 숨김 */
    align-items: center;
    justify-content: center;
    z-index: 50;
  }

  .consent-modal.show {
    display: flex;
  }

  .consent-modal-panel {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    max-width: 520px;
    width: 100%;
    margin: 0 16px;
    max-height: 70vh;
    display: flex;
    flex-direction: column;
  }

  .consent-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid #e5e7eb;
  }

  .consent-modal-title {
    font-size: 0.9rem;
    font-weight: 600;
  }

  .consent-modal-close {
    border: none;
    background: transparent;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
    color: #6b7280;
  }

  .consent-modal-close:hover {
    color: #111827;
  }

  .consent-modal-body {
    padding: 10px 12px 12px;
    font-size: 0.8rem;
    line-height: 1.5;
    white-space: pre-wrap;
    overflow-y: auto;
  }
  </style>
</head>
<body>
  <div class="container">
    <h1>국가건강검진 데이터 조회</h1>
    <p class="muted">간편인증을 완료한 뒤 “인증완료”를 누르면, 최근 10년 중 <b>가장 최근 일반검진 1건</b>을 연결합니다.</p>

    <div class="card">
      <div class="row">
        <div>
          <label style="font-size:12pt; font-weight:700;">간편인증 수단</label>
          <select id="loginOption">
            <option value="" selected>-- 선택 --</option>
            <option value="0">카카오톡</option>
            <option value="1">삼성패스</option>
            <option value="2">페이코</option>
            <option value="3">통신사 PASS인증서</option>
            <option value="4">KB모바일인증서</option>
            <option value="5">네이버인증서</option>
            <option value="6">신한인증서</option>
            <option value="7">토스인증서</option>
          </select>
        </div>
        <div id="telecomRow" style="display:none">
          <label style="font-size:12pt; font-weight:700;">통신사(PASS 선택 시)</label>
          <select id="telecom" class="mt-1 w-full border rounded px-3 py-2" disabled>
            <option value="" selected>-- 통신사 선택 --</option>
            <option value="1">KT</option>
            <option value="2">SKT</option>
            <option value="3">LG</option>
            <option value="4">KT알뜰폰</option>
            <option value="5">SKT알뜰폰</option>
            <option value="6">LG알뜰폰</option>
          </select>
        </div>
        <div>
           <label for="name" style="font-size:12pt; font-weight:700;">이름</label>
          <input id="name" type="text" placeholder="홍길동" value="{{ user_name or '' }}">
        </div>
        <div>
          <label for="phone" style="font-size:12pt; font-weight:700;">휴대폰 번호</label>
          <input id="phone" type="tel" inputmode="numeric" placeholder="01012345678" value="{{ user_phone or '' }}">
        </div>
        <div>
          <label for="birth"
                id="jLabel"
                class="block text-sm font-medium"
                style="font-size:12pt; font-weight:700;">
            생년월일(8자리)
          </label>
          <input id="birth" type="text" inputmode="numeric" placeholder="YYYYMMDD" class="mt-1 w-full border rounded px-3 py-2" maxlength="8"/>
        </div>
          <div class="row-inline" style="align-items:center; gap:16px;">
            <label class="block text-sm font-medium" style="font-size:12pt; font-weight:700; margin:0;">성별</label>
            <div class="gender-wrap" id="genderGroup" role="radiogroup" aria-label="성별" style="display:flex;gap:20px;">
              <label><input type="radio" name="gender" value="남"> <span>남</span></label>
              <label><input type="radio" name="gender" value="여"> <span>여</span></label>
            </div>
          </div>
      </div>
    </div>

<!-- 동의 영역 시작 -->
<div class="mt-6">
  <div class="consent-box">
    <!-- 1행: 전체 동의 -->
    <div class="consent-row consent-row-top">
      <label class="consent-label">
        <input type="checkbox" id="agree_all" class="consent-check">
        <span class="consent-label-text">전체 동의</span>
      </label>
    </div>

    <!-- 2행: 수집·이용 / 제3자 제공 -->
    <div class="consent-row">
      <div class="consent-col">
        <label class="consent-label">
          <input type="checkbox" id="agree_collect" class="consent-check">
          <span>개인정보 수집·이용 동의 <span class="consent-required">(필수)</span></span>
        </label>
        <button type="button"
                class="consent-view-btn"
                data-consent="collect">
          보기
        </button>
      </div>

      <div class="consent-col">
        <label class="consent-label">
          <input type="checkbox" id="agree_third" class="consent-check">
          <span>개인정보 제3자 제공 동의 <span class="consent-required">(필수)</span></span>
        </label>
        <button type="button"
                class="consent-view-btn"
                data-consent="third">
          보기
        </button>
      </div>
    </div>

    <!-- 3행: 고유식별 / 해외 이전 -->
    <div class="consent-row">
      <div class="consent-col">
        <label class="consent-label">
          <input type="checkbox" id="agree_unique" class="consent-check">
          <span>고유식별정보 처리 동의 <span class="consent-required">(필수)</span></span>
        </label>
        <button type="button"
                class="consent-view-btn"
                data-consent="unique">
          보기
        </button>
      </div>

      <div class="consent-col">
        <label class="consent-label">
          <input type="checkbox" id="agree_overseas" class="consent-check">
          <span>개인정보 해외 이전 동의 <span class="consent-required">(필수)</span></span>
        </label>
        <button type="button"
                class="consent-view-btn"
                data-consent="overseas">
          보기
        </button>
      </div>
    </div>
  </div>
</div>
<!-- 동의 영역 끝 -->


    <input type="hidden" id="nextUrl" value="{{ next_url or '/info' }}">

    <div class="card">
      <div class="mt-4 flex items-center gap-3">
        <button id="btnStart" type="button"
                class="big-round-btn big-round-btn-primary">
          간편인증 시작
        </button>
        <button id="btnComplete" type="button"
                class="big-round-btn big-round-btn-outline"
                disabled>
          인증완료
        </button>
      </div>
      <div id="status"
          class="status"
          style="margin-top:12px; font-size:12pt; font-weight:700;">
      </div>
      <div id="preview" class="preview" style="display:none"></div>
    </div>


<!-- 동의서 내용 모달 -->
<div id="consentModal" class="consent-modal">
  <div class="consent-modal-panel">
    <div class="consent-modal-header">
      <h2 id="consentModalTitle" class="consent-modal-title"></h2>
      <button type="button" id="consentModalClose" class="consent-modal-close">&times;</button>
    </div>
    <div id="consentModalBody" class="consent-modal-body"></div>
  </div>
</div>


<script>
(function(){
  const $ = (s)=>document.querySelector(s);

  // 요소들
  const loginSel   = $('#loginOption');
  const telecomRow = $('#telecomRow');
  const telecomSel = $('#telecom');
  const nameEl     = $('#name');
  const phoneEl    = $('#phone');
  const birthEl    = $('#birth');
  const genderRadios = document.getElementsByName('gender');

  const btnStart     = document.getElementById('btnStart');
  const btnComplete  = document.getElementById('btnComplete');
  const statusEl     = document.getElementById('status');
  const nextUrlEl    = document.getElementById('nextUrl');

  let gStartDone  = false;
  let callbackId  = '';

  // 동의 체크박스 & 모달 요소들
  const agreeAll      = document.getElementById('agree_all');
  const agreeCollect  = document.getElementById('agree_collect');
  const agreeThird    = document.getElementById('agree_third');
  const agreeUnique   = document.getElementById('agree_unique');
  const agreeOverseas = document.getElementById('agree_overseas');

  const consentModal      = document.getElementById('consentModal');
  const consentModalTitle = document.getElementById('consentModalTitle');
  const consentModalBody  = document.getElementById('consentModalBody');
  const consentModalClose = document.getElementById('consentModalClose');

  function allConsentChecked() {
    return (
      agreeCollect?.checked &&
      agreeThird?.checked &&
      agreeUnique?.checked &&
      agreeOverseas?.checked
    );
  }

  function syncAgreeAll() {
    if (agreeAll) {
      agreeAll.checked = allConsentChecked();
    }
  }

  function openConsentModal(kind) {
    if (!consentModal) return;
    const text = CONSENT_TEXTS[kind] || '';
    const titleMap = {
      collect:  '개인정보 수집·이용 동의',
      third:    '개인정보 제3자 제공 및 처리위탁 동의',
      unique:   '고유식별정보 처리 동의',
      overseas: '개인정보 해외 이전 동의'
    };
    if (consentModalTitle) {
      consentModalTitle.textContent = titleMap[kind] || '동의서 내용';
    }
    if (consentModalBody) {
      consentModalBody.textContent = text;
    }
    consentModal.classList.add('show');
  }

  function closeConsentModal() {
    if (!consentModal) return;
    consentModal.classList.remove('show');
  }

  if (consentModalClose) {
    consentModalClose.addEventListener('click', closeConsentModal);
  }

  if (consentModal) {
    consentModal.addEventListener('click', (e) => {
      if (e.target === consentModal) {
        closeConsentModal();
      }
    });
  }



  // [보기] 버튼 클릭
  document.querySelectorAll('.consent-view-btn[data-consent]').forEach(btn => {
    btn.addEventListener('click', () => {
      const kind = btn.getAttribute('data-consent');
      openConsentModal(kind);
    });
  });

  // 전체 동의 → 4개 모두 on/off
  if (agreeAll) {
    agreeAll.addEventListener('change', () => {
      const checked = agreeAll.checked;
      [agreeCollect, agreeThird, agreeUnique, agreeOverseas].forEach(el => {
        if (el) el.checked = checked;
      });
      validateStartEnabled();
    });
  }

  // 개별 동의 변경 시 전체 동의/버튼 상태 갱신
  [agreeCollect, agreeThird, agreeUnique, agreeOverseas].forEach(el => {
    if (!el) return;
    el.addEventListener('change', () => {
      syncAgreeAll();
      validateStartEnabled();
    });
  });

  function validateStartEnabled(){
    const opt     = loginSel?.value || '';
    const isPASS  = (opt === '3');
    const nameOk  = !!(nameEl?.value || '').trim();
    const phoneOk = onlyDigits(phoneEl?.value).length >= 9;
    const birthOk = onlyDigits(birthEl?.value).length === 8;
    const genderOk= !!selectedGender();
    const telOk   = !isPASS || !!(telecomSel?.value || '');

    const consentOk = allConsentChecked();

    btnStart.disabled = !(opt && nameOk && phoneOk && birthOk && genderOk && telOk && consentOk);
  }

 
  // 동의서 전문 텍스트
  const CONSENT_TEXTS = {
    collect: `개인정보 수집·이용 동의서

  본인은 가온앤 영양분석 서비스 제공을 위해 아래와 같이 개인정보를 수집·이용하는 것에 동의합니다.

  1. 수집하는 개인정보 항목
  - 성명
  - 생년월일(YYYYMMDD)
  - 성별
  - 휴대전화번호
  - 건강검진 조회를 위한 본인확인 인증 정보
  - 서비스 이용 과정에서 생성되는 문진 응답 정보

  2. 개인정보 수집·이용 목적
  - 본인확인 및 건강보험공단(NHIS) 건강검진 정보 조회
  - 문진 기반 식습관 분석 및 영양 리포트 제공
  - 서비스 품질 향상 및 사용자 문의 대응

  3. 개인정보 보유 및 이용 기간
  - 서비스 제공 목적 달성 후 1년간 보유
  - 법령에 따라 별도 보존이 필요한 경우 해당 기간까지 보존

  4. 동의 거부 권리 및 불이익
  - 귀하는 개인정보 수집·이용 동의를 거부할 수 있으나,
    미동의 시 서비스 이용(간편인증·검진조회·문진 서비스)이 제한됩니다.`,
    third: `개인정보 제3자 제공 및 처리위탁 동의서

  가온앤 영양분석 서비스는 서비스 제공 및 고객 지원을 위해 아래와 같이 개인정보를 제3자에게 제공하거나,
  개인정보 처리업무를 외부 전문 업체에 위탁할 수 있습니다. 본인은 아래 내용을 충분히 확인하였으며,
  이에 동의합니다.

  [1] 개인정보 제3자 제공

  1. 제공받는 자
    1) 국민건강보험공단(NHIS)
    2) 간편인증 대행기관(PASS, 각 통신사 및 공동인증 관련 기관)
    3) (주)글로벌금융 – 고객에게 분석 리포트를 전달(전화·문자·카카오톡·이메일·대면)

  2. 제공하는 개인정보 항목
  - 성명, 생년월일, 성별
  - 휴대전화번호
  - 건강검진 정보 조회를 위한 인증 정보
  - 분석 완료된 리포트 정보(주)글로벌금융에 한함)

  3. 제3자 이용 목적
  - NHIS 및 인증대행기관: 본인확인 및 건강검진 조회
  - (주)글로벌금융: 고객에게 분석 리포트 전달

  4. 보유 및 이용 기간
  - 제공 목적 달성 시까지 보유 후 즉시 파기

  5. 동의 거부 권리 및 불이익
  - 귀하는 제3자 제공에 동의하지 않을 수 있으나,
    동의하지 않을 경우 간편인증 기반 건강검진 조회 서비스 및
    담당자를 통한 리포트 전달 서비스 이용이 제한될 수 있습니다.

  [2] 개인정보 처리업무 위탁

  1. 수탁업체
  - (주)헬로
    (역할: Render.com 기반 웹서비스 및 DB 서버의 개발·운영·유지보수·배포)

  2. 위탁하는 업무의 내용
  - 서비스 운영을 위한 시스템 개발, 배포, 관리
  - 서버 운영 및 데이터베이스 관리
  - 서비스 장애 대응 및 성능 개선

  3. 위탁에 따라 제공되는 개인정보 항목
  - 서비스 운영 과정에서 저장·관리되는 개인정보 전반
    (단, 법령상 제한되거나 기술적으로 마스킹되는 항목은 제외)

  4. 보유 및 이용 기간
  - 위탁 계약 종료 또는 서비스 종료 시까지`,
    unique: `고유식별정보 처리 동의서

  가온앤 영양분석 서비스는 건강검진 조회를 위해 고유식별정보(생년월일)를 처리합니다.

  1. 처리하는 고유식별정보
  - 생년월일(YYYYMMDD)
  - 건강검진 본인확인 과정에서 필요한 고유 인증 식별값

  2. 처리 목적
  - 국민건강보험공단(NHIS) 건강검진 정보의 정확한 본인확인을 위한 인증

  3. 보유 및 이용 기간
  - 서비스 제공 목적 달성 후 즉시 삭제
  - 법령에 따라 보존이 필요한 경우 예외적으로 보관

  4. 동의 거부 권리 및 불이익
  - 고유식별정보 처리를 거부할 경우
    건강검진 연동 기반 서비스 이용이 제한됩니다.`,
    overseas: `개인정보 해외 이전 동의서

  가온앤 영양분석 서비스는 해외 클라우드 인프라를 기반으로 운영되며,
  서비스 제공을 위하여 아래와 같이 개인정보가 해외로 이전되어 저장·보관될 수 있습니다.
  본인은 다음의 내용을 충분히 이해하였으며 이에 동의합니다.

  1. 개인정보를 이전받는 자
  - Render, Inc. (미국)
    · 서비스명: Render.com
    · 소재지: 657 Mission St., Suite 200, San Francisco, CA 94105, USA

  2. 이전되는 개인정보 항목
  - 서비스 이용 로그(IP, User-Agent, 접속일시 등)
  - 인증 및 오류 처리 과정에서 생성되는 서버 기술 로그
  - 문진 응답 정보(문항별 선택값 포함)
  - 건강검진 조회 결과(NHIS 원문 데이터, 표준화 데이터)
  - 사용자 인적사항(성명, 생년월일, 성별, 휴대전화번호 등)
  - 리포트 생성에 필요한 모든 분석 데이터
    ※ 위 정보에는 민감정보(건강정보)가 포함될 수 있습니다.

  3. 이전 국가 및 저장 위치
  - 미국(USA), Oregon Region

  4. 이전 방법
  - 인터넷 네트워크를 통한 실시간 전송 방식 및 클라우드 저장

  5. 보유 및 이용 기간
  - 문진 응답 및 건강검진 데이터는 서비스 제공 목적 달성 후 1개월 보유 후 파기
  - 서비스 운영 과정에서 발생하는 시스템 로그는 1개월 보관 후 삭제
  - 관련 법령에 따라 별도 보존이 필요한 경우 해당 기간까지 보관

  6. 동의 거부 권리 및 불이익
  - 귀하는 개인정보 해외 이전에 동의하지 않을 수 있으나,
    이 경우 서비스 이용(건강검진 조회 및 문진·리포트 제공)이 제한될 수 있습니다.`
  };


  // 간편인증 시작
  btnStart.addEventListener('click', async () => {
    if (gStartDone) return;

    const loginOption = loginSel.value.trim();
    const telecomRaw  = (telecomSel?.value || '').trim();
    const telecom     = (loginOption === '3') ? telecomRaw : '';
    const name        = nameEl.value.trim();
    const phone       = onlyDigits(phoneEl.value).slice(0,11);
    const birth       = onlyDigits(birthEl.value).slice(0,8);
    const gender      = selectedGender();

    if (!gender){ alert('성별을 입력해주세요.'); return; }

    setStatus('간편인증 요청 전송 중...');
    btnStart.disabled = true;

    try {
      const rsp = await fetch('/api/dh/simple/start', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ loginOption, telecom, userName: name, hpNumber: phone, birth, gender })
      });
      const data = await rsp.json();
      console.log('[DH][start]', rsp.status, data);

      // ✅ 정상: callbackId 받은 경우
      if (rsp.ok && data.errCode === "0001" && data.data?.callbackId) {
        callbackId = data.data.callbackId;
        gStartDone = true;
        setStatus('휴대폰으로 간편인증 요청을 전송하였습니다.\n휴대폰에서 인증 완료 후 "인증완료"를 누르세요.', 'ok');
        btnComplete.disabled = false;
        return;
      }

      // 여기부터는 실패 케이스
      btnStart.disabled = false;
      gStartDone = false;

      // ✅ 백엔드에서 재시도 3회 후 타임아웃일 때
      if (data && data.errCode === "NETWORK_TIMEOUT") {
        const msg = data.message || "현재 국가건강검진 조회 서비스 연결이 불안정하여 연결에 실패하였습니다.\n잠시 후 다시 시도해주세요.";
        alert(msg);
        setStatus(msg, 'err');
      } else {
        // 그 외 일반 실패
        const msg = '간편인증 시작 실패: ' + (data.message || data.errCode || '오류');
        alert(msg);
        setStatus('간편인증 시작 실패', 'err');
      }
    } catch (e) {
      console.error(e);
      btnStart.disabled = false;
      gStartDone = false;
      // 진짜 네트워크/JS 예외 발생 시
      const msg = "국가건강검진 조회 서비스 연결에 실패하였습니다. 잠시 후 다시 시도해주세요.";
      alert(msg);
      setStatus(msg, 'err');
    }

  });

  // 인증완료(수동)
  btnComplete.addEventListener('click', async () => {
    if (!gStartDone) { alert('먼저 "간편인증 시작"을 진행해주세요.'); return; }
    setStatus('인증 완료 확인 중...');
    btnComplete.disabled = true;

    async function tryCompleteOnce() {
      const rsp = await fetch('/api/dh/simple/complete?all=1', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(callbackId ? { callbackId } : {}),
        credentials: 'include'
      });
      const data = await rsp.json().catch(()=> ({}));
      console.log('[COMPLETE][rsp]', rsp.status, data);

      if (rsp.status === 200 && data && data.ok) {
        setStatus('인증 및 데이터 수집 완료! 다음 단계로 이동합니다.', 'ok');
        window.location.href = (nextUrlEl.value || '/info');
        return true;
      }
      if (rsp.status === 202) {
        setStatus('인증완료 확인 중... 잠시만 기다려주세요.');
        return false;
      }
      alert(data && data.msg ? data.msg : '인증 확인 중 오류가 발생했습니다.');
      setStatus('오류가 발생했습니다. 다시 시도해 주세요.', 'err');
      return null;
    }

    const deadline = Date.now() + 60000;
    while (Date.now() < deadline) {
      const r = await tryCompleteOnce();
      if (r === true) return;
      if (r === null) break;
      await new Promise(res => setTimeout(res, 2000));
    }

    alert('아직 인증이 완료되지 않았습니다. 휴대폰에서 인증을 완료한 뒤 다시 "인증완료"를 눌러주세요.');
    setStatus('인증 대기 상태입니다. 인증 완료 후 다시 "인증완료"를 눌러주세요.', 'warn');
    btnComplete.disabled = false;
  });

  validateStartEnabled();
})();
</script>
</body>
</html>
