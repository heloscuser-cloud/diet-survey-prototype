{% extends "admin/base_admin.html" %}
{% block title %}신청내역 조회{% endblock %}

{% block content %}

<style>
  /* ✅ 모바일에서만: 테이블 가로 스크롤 */
  @media (max-width: 768px) {
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      border: 1px solid #eee;
      border-radius: 12px;
      background: #fff;
    }

    .table-scroll table {
      min-width: 900px;   /* 열이 많으면 더 키워도 됨 (예: 1100px) */
      table-layout: auto;
    }

    /* 너무 찌그러지지 않게 셀 줄바꿈 제한(필요하면) */
    .table-scroll th,
    .table-scroll td {
      white-space: nowrap;
    }
  }
</style>

<div style="max-width:960px; margin:24px auto; padding:0 12px;">

  <h2 style="font-size:20px; font-weight:700; margin-bottom:16px;">신청내역 조회</h2>

  <!-- 검색 영역 -->
  <div style="background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:16px 16px 12px 16px; margin-bottom:16px; box-shadow:0 6px 18px rgba(0,0,0,.03);">
    <form method="get" action="/partner/requests" style="display:flex; flex-direction:column; gap:10px;">

      <!-- 1행: 신청일(고객 또는 담당자) -->
      <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
        <div style="display:flex; flex-direction:column; font-size:13px;">
          <label style="color:#64748b; margin-bottom:4px;">신청일 (고객 또는 담당자신청일, 최대 31일)</label>
          <div style="display:flex; align-items:center; gap:6px;">
            <input type="text"
                   name="date_from"
                   inputmode="numeric"
                   placeholder="YYYY-MM-DD"
                   value="{{ date_from or '' }}"
                   class="date-ymd"
                   style="width:110px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;">
            <span>~</span>
            <input type="text"
                   name="date_to"
                   inputmode="numeric"
                   placeholder="YYYY-MM-DD"
                   value="{{ date_to or '' }}"
                   class="date-ymd"
                   style="width:110px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;">
          </div>
        </div>
      </div>

      <!-- 2행: 빠른 기간 선택 -->
      <div style="display:flex; flex-wrap:wrap; gap:8px; font-size:13px;">
        <span style="color:#64748b; align-self:center;">빠른 기간 선택</span>
        <button type="button" data-range="today"
                style="cursor:pointer; border:none; border-radius:999px; padding:4px 12px; font-size:13px; background:#e5e7eb;">
          오늘
        </button>
        <button type="button" data-range="1w"
                style="cursor:pointer; border:none; border-radius:999px; padding:4px 12px; font-size:13px; background:#e5e7eb;">
          1주
        </button>
        <button type="button" data-range="2w"
                style="cursor:pointer; border:none; border-radius:999px; padding:4px 12px; font-size:13px; background:#e5e7eb;">
          2주
        </button>
        <button type="button" data-range="1m"
                style="cursor:pointer; border:none; border-radius:999px; padding:4px 12px; font-size:13px; background:#e5e7eb;">
          1개월
        </button>
      </div>

      <!-- 3행: 고객명 / 휴대폰 뒷 4자리 -->
      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <div style="display:flex; flex-direction:column; font-size:13px;">
          <label style="color:#64748b; margin-bottom:4px;">고객명</label>
          <input type="text" name="client_name"
                 value="{{ client_name or '' }}"
                 placeholder="홍길동"
                 style="width:160px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;">
        </div>

        <div style="display:flex; flex-direction:column; font-size:13px;">
          <label style="color:#64748b; margin-bottom:4px;">고객연락처 (휴대폰 뒷번호 4자리)</label>
          <input type="text" name="client_phone_suffix" inputmode="numeric"
                 value="{{ client_phone_suffix or '' }}"
                 placeholder="1234"
                 maxlength="4"
                 style="width:140px; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px;">
        </div>
      </div>

      <!-- 4행: 진행 상태값 -->
      <div style="display:flex; flex-wrap:wrap; gap:12px;">
        <div style="display:flex; flex-direction:column; font-size:13px;">
          <label style="color:#64748b; margin-bottom:4px;">리포트 발송여부</label>
          <select name="status" style="width:200px; padding:8px 10px; border-radius:10px; border:1px solid #e5e7eb; font-size:14px;">
            <option value="" {{ 'selected' if not status }}>전체</option>
            <option value="unsent" {{ 'selected' if status=='unsent' }}>리포트 미발송</option>
            <option value="sent" {{ 'selected' if status=='sent' }}>리포트 발송완료</option>
          </select>
          <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
            <span style="color:#64748b; font-size:13px;">문진 미제출 인원만 보기</span>
            <input type="checkbox" name="only_not_submitted" value="1"
                  {{ 'checked' if only_not_submitted else '' }}>
          </div>
        </div>
      </div>

      <!-- 조회 버튼: 가운데 배치, 가로 넓게 -->
      <div style="margin-top:8px; display:flex; justify-content:center;">
        <button type="submit"
                style="cursor:pointer; border:none; border-radius:999px;
                       background:#1e40af; color:#ffffff;
                       padding:10px 48px; font-weight:600; font-size:14px;">
          조회
        </button>
      </div>

    </form>
  </div>

  <!-- 결과 테이블 -->
  <div class="table-scroll"; style="background:#ffffff; border:1px solid #e5e7eb; border-radius:16px; padding:0; box-shadow:0 6px 18px rgba(0,0,0,.03); overflow:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead>
        <tr style="background:#f3f4f6;">
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">연번</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">고객신청일</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">담당자신청일</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">고객명</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">고객연락처</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">진행 상태값</th>
          <th style="padding:10px 12px; font-size:13px; color:#4b5563; text-align:center;">리포트 발송여부</th>
        </tr>
      </thead>
      <tbody>
      {% if rows and rows|length > 0 %}
        {# rows: (pcm, resp, sr, rf) 튜플 #}
        {% for pcm, resp, sr, rf in rows %}
          {% set row_no = ((page|default(1)) - 1) * (page_size|default(50)) + loop.index %}
          <tr>
            <!-- 연번 -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {{ row_no }}
            </td>

            <!-- 고객신청일: partner_client_mapping.client_submitted_at -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {{ to_kst_str(pcm.client_submitted_at) if pcm.client_submitted_at else '' }}
            </td>

            <!-- 담당자신청일: partner_client_mapping.created_at -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {{ to_kst_str(pcm.created_at) }}
            </td>

            <!-- 고객명: 두 번째 글자 마스킹 -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {% set nm = pcm.client_name or '' %}
              {% if nm|length >= 2 %}
                {{ nm[0] ~ '*' ~ nm[2:] }}
              {% else %}
                {{ nm }}
              {% endif %}
            </td>

            <!-- 고객연락처: 010****0000 형식으로 마스킹 -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {% set ph = pcm.client_phone or '' %}
              {% if ph|length >= 7 %}
                {{ ph[:3] ~ '****' ~ ph[-4:] }}
              {% else %}
                {{ ph }}
              {% endif %}
            </td>

            <!-- 진행 상태값 -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {% set st = resp.status if resp else '' %}
              {% set has_client_submitted = (pcm.client_submitted_at is not none) %}
              {% set has_partner_requested = (pcm.created_at is not none) %}

              {% if st == 'report_sent' %}
                <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#e0f2fe; font-size:12px;">리포트발송완료</span>

              {% elif st == 'report_uploaded' %}
                {# requests에서는 report_uploaded를 "리포트 발송대기"로 표시 #}
                <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#fee2e2; font-size:12px;">리포트 발송대기</span>

              {% elif st == 'accepted' %}
                <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#dcfce7; font-size:12px;">접수완료</span>

              {% elif st == 'submitted' %}
                {# submitted에서 분석신청/문진제출/문진미제출을 파생 #}
                {% if has_partner_requested and has_client_submitted %}
                  <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px;">분석신청</span>
                {% elif has_partner_requested and (not has_client_submitted) %}
                  <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#fef9c3; font-size:12px;">문진 미제출</span>
                {% else %}
                  <span style="display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; font-size:12px;">문진제출</span>
                {% endif %}

              {% else %}
                <span style="font-size:12px; color:#6b7280;">{{ st or '-' }}</span>
              {% endif %}
            </td>

            <!-- 리포트 발송여부 -->
            <td style="padding:10px 12px; font-size:14px; text-align:center;">
              {% if resp and resp.status == 'report_sent' %}
                <span style="color:#16a34a; font-weight:600;">발송</span>
              {% else %}
                <span style="color:#6b7280;">미발송</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" style="padding:20px; text-align:center; font-size:14px; color:#6b7280;">
            조회 결과가 없습니다.
          </td>
        </tr>
      {% endif %}
      </tbody>
    </table>

    <!-- 페이지네이션 -->
    <div class="pagination" style="justify-content:center; padding:10px 12px;">
    {% if total_pages and total_pages > 1 %}
      {% set cur_page = page|default(1) %}

      {% if cur_page > 1 %}
        <a href="/partner/requests?page={{ cur_page - 1 }}&date_from={{ date_from }}&date_to={{ date_to }}&client_name={{ client_name }}&client_phone_suffix={{ client_phone_suffix }}&status={{ status }}">이전</a>
      {% endif %}

      {% for p in range(1, total_pages + 1) %}
        {% if p == cur_page %}
          <span>{{ p }}</span>
        {% else %}
          <a href="/partner/requests?page={{ p }}&date_from={{ date_from }}&date_to={{ date_to }}&client_name={{ client_name }}&client_phone_suffix={{ client_phone_suffix }}&status={{ status }}">{{ p }}</a>
        {% endif %}
      {% endfor %}

      {% if cur_page < total_pages %}
        <a href="/partner/requests?page={{ cur_page + 1 }}&date_from={{ date_from }}&date_to={{ date_to }}&client_name={{ client_name }}&client_phone_suffix={{ client_phone_suffix }}&status={{ status }}">다음</a>
      {% endif %}
    {% endif %}

    </div>

  </div>

</div>

<script>
  function pad2(n) { return String(n).padStart(2, "0"); }

  // ✅ UTC(toISOString) 금지. 로컬(KST 포함) 기준 YYYY-MM-DD 생성
  function formatLocalYYYYMMDD(d) {
    const y = d.getFullYear();
    const m = pad2(d.getMonth() + 1);
    const day = pad2(d.getDate());
    return `${y}-${m}-${day}`;
  }

  document.addEventListener('DOMContentLoaded', function() {
    const fromInput = document.querySelector('input[name="date_from"]');
    const toInput = document.querySelector('input[name="date_to"]');

    // 날짜 입력 자동 포맷 (YYYY-MM-DD)
    document.querySelectorAll('.date-ymd').forEach(function(inp) {
      inp.addEventListener('input', function(e) {
        let v = e.target.value.replace(/[^0-9]/g, '').slice(0,8);

        // 4자리 입력한 순간 바로 "YYYY-" 보이게
        if (v.length >= 4) {
          v = v.slice(0,4) + '-' + v.slice(4);
        }
        // 6자리 이상이면 "YYYY-MM-" 까지 보이게
        if (v.length >= 7) {
          v = v.slice(0,7) + '-' + v.slice(7);
        }

        e.target.value = v;
      });
    });

// 빠른 기간 버튼
document.querySelectorAll('[data-range]').forEach(function(btn) {
  btn.addEventListener('click', function() {
    const type = this.getAttribute('data-range');

    // ✅ KST 포함 '로컬 날짜' 기준으로 계산되도록:
    const today = new Date();
    today.setHours(12, 0, 0, 0); // (권장) 날짜 밀림 방지용 정오 고정

    const toStr = formatLocalYYYYMMDD(today);

    let from = new Date(today);
    if (type === 'today') {
      // 오늘 하루
    } else if (type === '1w') {
      from.setDate(today.getDate() - 6); // 오늘 포함 7일
    } else if (type === '2w') {
      from.setDate(today.getDate() - 13); // 오늘 포함 14일
    } else if (type === '1m') {
      from.setDate(today.getDate() - 30); // 오늘 포함 31일 근처
    }

    const fromStr = formatLocalYYYYMMDD(from);

    if (fromInput) fromInput.value = fromStr;
    if (toInput) toInput.value = toStr;
  });
});


  });
</script>

{% endblock %}
