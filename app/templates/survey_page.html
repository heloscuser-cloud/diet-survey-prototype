<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>설문 {{ step }}/3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Arial, sans-serif; margin:0; background:#f7f7f8; }
    .wrap { max-width: 720px; margin: 16px auto; padding: 12px; }
    .card { background:#fff; border-radius:14px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    h1 { font-size:18px; margin:0 0 6px; }
    .q { margin:14px 0; }
    .q-title { font-weight:600; margin-bottom:8px; line-height:1.4; }
    label.opt { display:block; padding:10px 12px; border:1px solid #e5e7eb; border-radius:10px; margin:6px 0; }
    input[type="radio"], input[type="checkbox"] { margin-right:8px; }
    .nav { display:flex; gap:8px; margin-top:12px; }
.btn {
  flex: 1;
  padding: 14px;
  border-radius: 12px;
  border: 0;
  font-weight: 600;
  font-size: 16px;       /* ← 버튼/링크 모두 동일 폰트 크기 */
  font-family: inherit;  /* ← 시스템 폰트 상속으로 통일 */
}
a.btn {
  text-decoration: none;   /* ← 링크 밑줄 제거 */
  display: inline-block;   /* ← 버튼과 레이아웃 일치 */
  text-align: center;      /* ← 가운데 정렬 보장 */
}
    .btn.prev { background:#111827; color:#fff; }
    .btn.next { background:#111827; color:#fff; opacity:.5; }
    .btn.next.enabled { opacity:1; }
    .progress { font-size:13px; color:#6b7280; margin-bottom:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="progress">단계 {{ step }} / 3</div>

    <form class="card" method="post" action="/survey/step/{{ step }}" id="surveyForm">
      <input type="hidden" name="acc" id="accInput" value='{{ acc|e }}'>
      <input type="hidden" name="rtoken" value='{{ rtoken|e }}'>

      {% for q in questions %}
        <div class="q" data-qid="{{ q.id }}">
          <div class="q-title">{{ q.id }}. {{ q.title or q.text or q.label or q.question }}</div>

{% if q.type == "radio" %}
  {% for opt in q.options %}
    <label class="opt">
      <input type="radio" name="q{{ q.id }}" value="{{ loop.index }}" required />
      <span>{{ opt }}</span>
    </label>
  {% endfor %}
{% elif q.type == "checkbox" %}
  {% for opt in q.options %}
    <label class="opt">
      <input type="checkbox" name="q{{ q.id }}" value="{{ loop.index }}" />
      <span>{{ opt }}</span>
    </label>
  {% endfor %}
{% endif %}
        </div>
      {% endfor %}

      <div class="nav">
        {% if not is_first %}
          <a class="btn prev" href="/survey/step/{{ step - 1 }}?acc={{ acc|urlencode }}&rtoken={{ rtoken|urlencode }}">이전</a>
        {% endif %}
        <button type="submit" class="btn next" id="nextBtn" disabled>
          {{ "제출" if is_last else "다음" }}
        </button>
      </div>
    </form>
  </div>

  <script>
    const form = document.getElementById('surveyForm');
    const nextBtn = document.getElementById('nextBtn');
    const accEl = document.getElementById('accInput');

    // 이전 단계 답 복원
    (function restoreSelections(){
      let data = {};
      try { data = JSON.parse(accEl.value || "{}"); } catch(e) {}
      for (const [key, v] of Object.entries(data)) {
        if (Array.isArray(v)) {
          v.forEach(n => {
            const el = form.querySelector(`input[name="${key}"][value="${String(n)}"]`);
            if (el) el.checked = true;
          });
        } else {
          const el = form.querySelector(`input[name="${key}"][value="${String(v)}"]`);
          if (el) el.checked = true;
        }
      }
    })();

    // 모든 문항 응답 시 다음/제출 활성화
    function validate() {
      const blocks = document.querySelectorAll('.q');
      let ok = true;
      blocks.forEach(block => {
        const radios = block.querySelectorAll('input[type="radio"]');
        const checkboxes = block.querySelectorAll('input[type="checkbox"]');
        if (radios.length) {
          const any = Array.from(radios).some(r => r.checked);
          if (!any) ok = false;
        } else if (checkboxes.length) {
          const any = Array.from(checkboxes).some(c => c.checked);
          if (!any) ok = false;
        }
      });
      nextBtn.disabled = !ok;
      nextBtn.classList.toggle('enabled', ok);
    }

    form.addEventListener('change', validate);
    window.addEventListener('load', validate);
  </script>
</body>
</html>
