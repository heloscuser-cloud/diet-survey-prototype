<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>응답 목록</title>
  <style>
    body{font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif;background:#f6f7fb;margin:0;padding:24px}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;margin-bottom:16px}
    .title{font-weight:700;margin:0 0 12px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    label{font-size:12px;color:#64748b;display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    button.primary{background:#111827;color:#fff;border:none}
    .row{display:flex;gap:12px;align-items:end}
    .row .grow{flex:1}
    .actions{display:flex;gap:8px;justify-content:flex-end}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #e5e7eb;padding:10px;font-size:14px;text-align:left}
    th{background:#f3f4f6}
    .right{display:flex;gap:8px;justify-content:flex-end}
    .btn{padding:8px 12px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;white-space:nowrap; height:34px;}
    .btn.primary{background:#111827;color:#fff;border:none}
    .nowrap{white-space:nowrap}
    .muted{color:#6b7280}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;background:#eef2ff}
   .w-date{ width: 160px; }  /* 날짜 입력 폭 */
   .w-status{ width: 220px; }/* 상태 콤보 폭(한글 ~15자 정도) */
   .w-text{ width: 480px; }  /* 텍스트 검색(~30자) */
  </style>
</head>
<body>
<div class="wrap">

  <!-- 검색 조건 박스 -->
<div class="card">
  <h2 class="title">검색 조건</h2>
  <form id="searchForm" method="get" action="/admin/responses">
<!-- 1행: 신청일 + 빠른버튼 (바짝 붙이기) -->
<div class="row" style="gap:8px; align-items:center">
  <div class="row" style="gap:6px; align-items:center">
    <label style="margin:0">신청일</label>
    <input class="w-date date-ymd" type="text" name="from" inputmode="numeric" placeholder="YYYY-MM-DD" value="{{ from or '' }}"/>
    <span>~</span>
    <input class="w-date date-ymd" type="text" name="to" inputmode="numeric" placeholder="YYYY-MM-DD" value="{{ to or '' }}"/>
  </div>
  <div class="row" style="gap:6px; align-items:center">
    <button type="button" class="btn" onclick="shiftDays(-1)">◀</button>
    <button type="button" class="btn" onclick="shiftDays(1)">▶</button>
    <button type="button" class="btn" onclick="setToday()">오늘</button>
    <button type="button" class="btn" onclick="setWeek()">일주일</button>
  </div>
</div>

    <!-- 2행: 진행 상태 -->
    <div class="row" style="margin-top:8px">
      <div class="grow">
        <label>진행 상태</label>
       <select name="status" class="w-status">
          <option value="" {{ 'selected' if not status }}>전체</option>
          <option value="submitted" {{ 'selected' if status=='submitted' }}>신청완료</option>
          <option value="accepted" {{ 'selected' if status=='accepted' }}>접수완료</option>
          <option value="report_uploaded" {{ 'selected' if status=='report_uploaded' }}>리포트 업로드 완료</option>
        </select>
      </div>
    </div>

<!-- 3행: 텍스트 검색 -->
<div class="row" style="margin-top:8px">
  <div class="grow">
    <label>텍스트 검색</label>
    <input type="text" name="q" class="w-text" value="{{ q or '' }}" placeholder="신청자 이름, 신청자 생년월일(YYYY-MM-DD), PDF 파일명으로 검색"/>
  </div>
</div>

<!-- 4행: 가운데 정렬된 조회 버튼 -->
<div class="row" style="margin-top:8px;justify-content:center">
  <button class="btn" type="submit" style="min-width:140px;padding:10px 14px">조회</button>
</div>
  </form>
</div>


  <!-- 검색조건 아래 우측 버튼 -->
  <div class="card" style="display:flex;justify-content:flex-end;gap:8px">
<form id="acceptForm" method="post" action="/admin/responses/accept">
  <input type="hidden" name="ids" id="acceptIds"/>
  <button class="btn" type="button" onclick="bulkAccept()">접수 완료 처리</button>
</form>

<form id="xlsxForm"   method="post" action="/admin/responses/export.xlsx">
  <input type="hidden" name="ids"/>
  <button class="btn" type="button" onclick="bulkXlsx()">엑셀 다운로드</button>
</form>
  </div>

  <!-- 조회 테이블 -->
  <div class="card">
<table>
  <thead>
    <tr>
      <th><input type="checkbox" id="chkAll" onclick="toggleAll(this)"/></th>
      <th>신청번호</th>
      <th>신청자</th>
      <th>PDF 파일명</th>
      <th>업로드 날짜</th>
      <th>진행 상태값</th>
      <th>신청일</th>
      <th>제출일</th>
      <th>리포트</th>
    </tr>
  </thead>
  <tbody>
  {% for sr, resp, user, rf in rows %}
    <tr>
      <td><input type="checkbox" class="rowChk" value="{{ sr.id }}"/></td>
      <td class="nowrap">{{ resp.serial_no or '' }}</td>
      <td>{{ resp.applicant_name or user.name_enc or '-' }} ({{ resp.birth_date or '' }}, {{ resp.gender or user.gender or '-' }})</td>
      <td>{{ rf.filename if rf else '' }}</td>
      <td>{{ to_kst_str(rf.uploaded_at) if rf else '' }}</td>
      <td>
        {% if resp.status=='submitted' %}<span class="tag">신청완료</span>
        {% elif resp.status=='accepted' %}<span class="tag">접수완료</span>
        {% elif resp.status=='report_uploaded' %}<span class="tag">리포트 업로드 완료</span>
        {% else %}<span class="muted">{{ resp.status }}</span>{% endif %}
      </td>
      <td>{{ to_kst_str(resp.created_at) }}</td>
      <td>{{ to_kst_str(sr.submitted_at) }}</td>
      <td class="nowrap">
        <!-- 업로드: 작은 정사각 아이콘 -->
        <form style="display:inline" method="post" action="/admin/response/{{ sr.id }}/report" enctype="multipart/form-data">
          <input id="file_{{ sr.id }}" type="file" name="file" accept="application/pdf" style="display:none" onchange="this.form.submit()"/>
          <label for="file_{{ sr.id }}" title="리포트 등록"
                 style="cursor:pointer;display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #e5e7eb;border-radius:6px">
            <img src="/static/icons/plus.svg" alt="등록" style="width:16px;height:16px"/>
          </label>
        </form>

        <!-- 삭제: 작은 정사각 아이콘 -->
        {% if rf %}
        <form style="display:inline" method="post" action="/admin/response/{{ sr.id }}/report/delete">
          <button type="submit" title="리포트 삭제"
                  style="display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;cursor:pointer">
            <img src="/static/icons/trash.svg" alt="삭제" style="width:16px;height:16px"/>
          </button>
        </form>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>

</div>


<script>
function fmt(d){const z=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;}
function getDates(){const f=document.querySelector('input[name=from]');const t=document.querySelector('input[name=to]');return [f,t];}
function shiftDays(n){let [f,t]=getDates();let fd=f.value?new Date(f.value):new Date();let td=t.value?new Date(t.value):new Date();fd.setDate(fd.getDate()+n);td.setDate(td.getDate()+n);f.value=fmt(fd);t.value=fmt(td);}
function setToday(){let [f,t]=getDates();let d=new Date();f.value=fmt(d);t.value=fmt(d);}
function setWeek(){let [f,t]=getDates();let td=new Date();let fd=new Date();fd.setDate(td.getDate()-6);f.value=fmt(fd);t.value=fmt(td);}

function getSelectedIds() {
  return Array.from(document.querySelectorAll('.rowChk:checked'))
    .map(el => el.value)
    .filter(Boolean);
}
function bulkAccept(){
  const ids=[...document.querySelectorAll('.rowChk:checked')].map(c=>c.value);
  if(ids.length===0){alert('선택된 항목이 없습니다.');return;}
  document.getElementById('acceptIds').value = ids.join(',');
  document.getElementById('acceptForm').submit();
}
function bulkXlsx(){
  const ids=[...document.querySelectorAll('.rowChk:checked')].map(c=>c.value);
  if(ids.length===0){alert('선택된 항목이 없습니다.');return;}
  document.getElementById('xlsxIds').value = ids.join(',');
  document.getElementById('xlsxForm').submit();
}
function toggleAll(master) {
  document.querySelectorAll('.rowChk').forEach(cb => cb.checked = master.checked);
}
document.querySelectorAll('.date-ymd').forEach(inp=>{
  inp.addEventListener('input', e=>{
    let v = e.target.value.replace(/[^\d]/g,'').slice(0,8);
    if (v.length>=5) v = v.slice(0,4)+'-'+v.slice(4);
    if (v.length>=8) v = v.slice(0,7)+'-'+v.slice(7);
    e.target.value = v;
  });
  inp.addEventListener('keyup', e=>{
    const v=e.target.value;
    // 연도 4자리 입력 후 자동으로 다음 필드(같은 행에서 다음 date-ymd)로 이동
    if (e.key>='0' && e.key<='9') {
      const parts=v.split('-');
      if (parts[0] && parts[0].length===4 && !parts[1]) {
        // 하이픈은 이미 찍혔으므로 그대로 월 2자리 입력 대기
        // 포커스 유지 (같은 필드에서 월 계속 입력)
      }
    }
  });
});
</script>
</body>
</html>