{% extends "admin/base_admin.html" %}
{% block title %}가온앤 관리자페이지{% endblock %}

{% block content %}
<style>
  :root{
    --bg:#f6f7fb;
    --card:#fff;
    --border:#e5e7eb;
    --text:#111827;
    --muted:#6b7280;
    --btn1:#1e40af; /* 조회 */
    --btn2:#06b6d4; /* 접수 */
    --btn3:#0ea5e9; /* 엑셀 */
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  /* 전체 폭 꽉 채우기 */
  .page{width:100%; max-width:1366px; margin:0 auto; padding:20px}
  /* 카드 */
  .card{background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 6px 18px rgba(0,0,0,.04)}
  /* 검색 카드: 왼쪽 정렬 */
  .search-card{padding:16px 16px 8px 16px; margin-bottom:10px;}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  .row>div{display:flex; gap:8px; align-items:center}
  label{font-size:12px; color:#64748b}
  input, select{padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; font-size:14px}
  .w-date{width:150px}
  .w-status{width:210px}
  .w-text{ width:360px }
  /* 컨트롤 바: 검색과 테이블 사이, 왼쪽 정렬 */
  .control-bar{display:flex; justify-content:flex-start; gap:8px; padding:8px 12px; margin-bottom:10px;}
  .control-bar{position:relative; z-index:50;}
  .control-bar.card{border-radius:12px}
  /* 테이블: 화면 가득 */
  .table-card{padding:0; overflow:auto;}
  table{width:100%; border-collapse:collapse; table-layout:auto; background:#fff}
  th, td{padding:10px 12px; border-bottom:1px solid var(--border); font-size:14px; text-align:center}
  th{background:#f3f4f6; text-align:left}
  .nowrap{white-space:nowrap}
  .tag{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff}
  .muted{color:var(--muted)}
  /* 테이블만 화면폭에 가깝게 확장(FHD 기준). 필터/검색 영역(.page)은 기존 유지 */
.table-wide{
  width: calc(100vw - 40px);
  margin-left: 50%;
  transform: translateX(-50%);
}
@media (max-width: 768px){
  .table-wide{
    width: 100%;
    margin-left: 0;
    transform: none;
  }
}

/* 담당자 정보 툴팁 */
.info-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  width:18px;
  height:18px;
  margin-left:6px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  line-height:1;
  border:1px solid var(--border);
  background:#fff;
  cursor:pointer;
  user-select:none;
}
.tooltip{
  position:absolute;
  z-index:9999;
  min-width:220px;
  background:#fff;
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 10px 24px rgba(0,0,0,.12);
  padding:10px 12px;
  font-size:13px;
  text-align:left;
  display:none;
}
.tooltip .rowline{display:flex; gap:8px; margin:4px 0}
.tooltip .k{width:66px; color:var(--muted)}
.tooltip .v{flex:1; color:var(--text); word-break:break-all}

  /* 버튼 */
  .btn{cursor:pointer; border:none; border-radius:999px; color:#fff; padding:.5rem 1rem; font-weight:600}
  .btn:hover{opacity:.95}
  .btn:active{opacity:.9}
  .btn-primary{background:var(--btn1)}
  .btn-cyan{background:var(--btn2)}
  .btn-sky{background:var(--btn3)}
  .btn-sm{padding:.4rem .8rem; font-weight:600;}
  .iconbtn{width:28px; height:28px; border:none; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#7ED2FF; cursor:pointer}
  .iconbtn2{width:28px; height:28px; border:none; border-radius:8px; display:inline-flex; align-items:center; justify-content:center; background:#FFB4B4; cursor:pointer}
  .iconbtn:hover{opacity:.9}
  .pagination{display:flex; justify-content:center; gap:6px; margin:16px 0}
  .pagination a, .pagination span{
    display:inline-block; min-width:28px; padding:6px 10px; border-radius:8px; text-decoration:none
  }
  .pagination a{ background:#e5e7eb; color:#1e293b}
  .pagination span{ background:#1e40af; color:#fff; font-weight:700}
  .pagesize-card{display:flex; align-items:center; gap:8px; padding:8px 12px; margin-bottom:10px}
  .ico{width:16px; height:16px}
  table thead th, table tbody td { text-align: center !important; }

/* base_admin.html의 큰 흰 래퍼(.wrap)를 responses 페이지에서만 제거 */
body > .wrap {
  background: transparent;
  box-shadow: none;
  padding: 0;
}
  
</style>

<div class="page">


  <!-- 검색 조건: 전체 하얀 영역, 왼쪽 정렬 -->
  <div class="card search-card">
    <form id="searchForm" method="get" action="/admin/responses">
      <!-- 1행: 신청일 + 빠른 버튼 -->
      <div class="row" style="margin-bottom:8px;">
        <div>
          <label>신청일</label>
          <input class="w-date date-ymd" type="text" name="from" inputmode="numeric" placeholder="YYYY-MM-DD" value="{{ from or '' }}"/>
          <span>~</span>
          <input class="w-date date-ymd" type="text" name="to" inputmode="numeric" placeholder="YYYY-MM-DD" value="{{ to or '' }}"/>
        </div>
        <div>
          <button type="button" class="btn btn-sm btn-cyan" onclick="shiftDays(-1)">◀</button>
          <button type="button" class="btn btn-sm btn-cyan" onclick="shiftDays(1)">▶</button>
          <button type="button" class="btn btn-sm btn-cyan" onclick="setToday()">오늘</button>
          <button type="button" class="btn btn-sm btn-cyan" onclick="setWeek()">일주일</button>
        </div>
      </div>

      <!-- 2행: 진행 상태 -->
      <div class="row" style="margin-bottom:8px;">
        <div>
          <label>진행 상태</label>
          <select name="status" class="w-status">
<option value="" {{ 'selected' if not status }}>전체</option>
<option value="submitted" {{ 'selected' if status=='submitted' }}>문진제출</option>
<option value="analysis_requested" {{ 'selected' if status=='analysis_requested' }}>분석신청</option>
<option value="accepted" {{ 'selected' if status=='accepted' }}>접수완료</option>
<option value="report_uploaded" {{ 'selected' if status=='report_uploaded' }}>리포트 업로드 완료</option>
<option value="report_sent" {{ 'selected' if status=='report_sent' }}>리포트 발송 완료</option>


          </select>
        </div>
      </div>

      <!-- 3행: 텍스트 검색 -->
      <div class="row" style="margin-bottom:4px;">
        <div>
          <label>텍스트 검색</label>
          <input type="text" name="q" class="w-text" value="{{ q or '' }}" placeholder="신청자 이름, 신청자 생년월일(YYYY-MM-DD), PDF 파일명"/>
        </div>
      </div>

<!-- 4행: 페이지당 조회 수 + 조회 버튼 (같은 줄, 왼쪽 정렬) -->
<div class="row" style="margin-top:4px;">
  <div>
    <label for="page_size" style="font-size:12px; color:#64748b;">페이지당 조회 수</label>
    <select name="page_size" id="page_size" style="width:120px; padding:6px 8px; border:1px solid var(--border); border-radius:10px;">
      <option value="50"  {{ 'selected' if (page_size or '50') == '50'  }}>50</option>
      <option value="100" {{ 'selected' if page_size == '100' }}>100</option>
      <option value="all" {{ 'selected' if page_size == 'all' }}>전체</option>
    </select>
  </div>

  <button class="btn btn-primary" type="submit" style="width:200px;">조회</button>

  <!-- 조회 시 유지할 hidden들 -->
  <input type="hidden" name="page" value="1">
</div>
    </form>
  </div>

  <!-- 컨트롤 바: 접수/엑셀 (검색 조건과 테이블 사이, 우측 정렬) -->
  <div class="card control-bar">
    <form id="acceptForm" method="post" action="/admin/responses/accept" style="margin:0">
      <input type="hidden" name="ids" id="acceptIds">
      <input type="hidden" name="next" id="acceptNext">
      <button class="btn btn-cyan btn-sm" type="button" onclick="bulkAccept()" style="width:120px;">접수 완료</button>
    </form>
    <form id="xlsxForm" method="post" action="/admin/responses/export.xlsx" style="margin:0">
      <input type="hidden" name="ids" id="xlsxIds">
      <input type="hidden" name="next" id="xlsxNext">
      <button class="btn btn-sky btn-sm" type="button" onclick="bulkXlsx()" style="width:120px;">엑셀 다운로드</button>
    </form>
    <form id="sendForm" method="post" action="/admin/responses/report/send" style="margin:0">
  <input type="hidden" name="ids" id="sendIds">
  <input type="hidden" name="next" id="sendNext">
  <button class="btn btn-cyan btn-sm" type="button" onclick="bulkSendReport()" style="width:120px;">리포트발송</button>
</form>

  </div>

  <!-- 테이블: 화면 가득 -->
  <div class="card table-card table-wide">
    <table>
      <thead>
        <tr>
<th><input type="checkbox" id="chkAll" onclick="toggleAll(this)"/></th>
<th>신청번호</th>
<th>신청자</th>
<th>담당자</th>
<th>담당자 소속</th>
<th>PDF 파일명</th>
<th>업로드 날짜</th>
<th>진행 상태값</th>
<th>문진제출일</th>
<th>담당자신청일</th>
<th>리포트</th>

        </tr>
      </thead>
      <tbody>
      {% for sr, resp, user, rf, ua, partner_requested_at in rows %}

       <tr>
  <td><input type="checkbox" class="rowChk" value="{{ sr.id }}"></td>

  <td class="nowrap">{{ resp.serial_no or '' }}</td>

  <td>{{ resp.applicant_name or user.name_enc or '-' }} ({{ resp.birth_date or '' }}, {{ resp.gender or user.gender or '-' }})</td>

  <!-- 담당자 + ⓘ 툴팁 -->
  <td class="nowrap" style="position:relative;">
    {{ ua.name if ua else '' }}
    <span class="info-icon" data-tip-id="tip_{{ sr.id }}">ⓘ</span>

    <div class="tooltip" id="tip_{{ sr.id }}">
      <div class="rowline"><div class="k">소속</div><div class="v">{{ ua.division if ua else '' }}</div></div>
      <div class="rowline"><div class="k">부서</div><div class="v">{{ ua.department if ua else '' }}</div></div>
      <div class="rowline"><div class="k">이름</div><div class="v">{{ ua.name if ua else '' }}</div></div>
      <div class="rowline"><div class="k">전화</div><div class="v">{{ ua.phone if ua else '' }}</div></div>
      <div class="rowline"><div class="k">메일</div><div class="v">{{ ua.mail if ua else '' }}</div></div>
    </div>
  </td>

  <!-- 담당자 소속 -->
  <td class="nowrap">{{ ua.division if ua else '' }}</td>

  <!-- PDF 파일명 -->
  <td>{{ rf.filename if rf else '' }}</td>

  <!-- 업로드 날짜 -->
  <td>{{ to_kst_str(rf.uploaded_at) if rf else '' }}</td>

  <!-- 진행 상태값 -->
  <td>
    {% if resp.status=='submitted' %}
      {% if partner_requested_at %}
        <span class="tag">분석신청</span>
      {% else %}
        <span class="tag">문진제출</span>
      {% endif %}
    {% elif resp.status=='accepted' %}
      <span class="tag">접수완료</span>
    {% elif resp.status=='report_uploaded' %}
      <span class="tag">리포트 업로드 완료</span>
      {% elif resp.status=='report_sent' %}
  <span class="tag">리포트 발송 완료</span>

    {% else %}
      <span class="muted">{{ resp.status }}</span>
    {% endif %}
  </td>

  <!-- 문진제출일 -->
  <td>{{ to_kst_str(sr.submitted_at) }}</td>

  <!-- 담당자신청일 -->
  <td>{{ to_kst_str(partner_requested_at) if partner_requested_at else '' }}</td>

  <!-- 리포트 -->
  <td class="nowrap">
    <form style="display:inline" method="post" action="/admin/response/{{ sr.id }}/report" enctype="multipart/form-data">
      <input id="file_{{ sr.id }}" type="file" name="file" accept="application/pdf" style="display:none" onchange="this.form.submit()"/>
      <input type="hidden" name="next" class="rowNext">
      <label for="file_{{ sr.id }}" title="리포트 등록" class="iconbtn">
        <img class="ico" src="/static/icons/plus.svg" alt="등록"/>
      </label>
    </form>

    {% if rf %}
    <form style="display:inline" method="post" action="/admin/response/{{ sr.id }}/report/delete">
      <input type="hidden" name="next" class="rowNext">
      <button type="submit" title="리포트 삭제" class="iconbtn2">
        <img class="ico" src="/static/icons/trash.svg" alt="삭제"/>
      </button>
    </form>
    {% endif %}
  </td>
</tr>

      {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 페이지네이션 -->
  <div class="pagination">
    {% if total_pages > 1 %}
      {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
          <span>{{ p }}</span>
        {% else %}
<a href="/admin/responses?page={{ p }}&page_size={{ page_size or '50' }}&from={{ from }}&to={{ to }}&status={{ status }}&q={{ q }}">{{ p }}</a>
        {% endif %}
      {% endfor %}
    {% endif %}
  </div>

</div>

<script>

// 날짜 유틸 (그대로 유지)
function z(n){return String(n).padStart(2,'0')}
function fmt(d){return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`}
function getDates(){const f=document.querySelector('input[name=from]');const t=document.querySelector('input[name=to]');return [f,t]}
function shiftDays(n){let [f,t]=getDates();let fd=f.value?new Date(f.value):new Date();let td=t.value?new Date(t.value):new Date();fd.setDate(fd.getDate()+n);td.setDate(td.getDate()+n);f.value=fmt(fd);t.value=fmt(td)}
function setToday(){let [f,t]=getDates();let d=new Date();f.value=fmt(d);t.value=fmt(d)}
function setWeek(){let [f,t]=getDates();let td=new Date();let fd=new Date();fd.setDate(td.getDate()-6);f.value=fmt(fd);t.value=fmt(td)}

// (교체) 검색 폼: 기본 GET 제출만
(function(){
  const f = document.getElementById("searchForm");
  if (!f) return;
  f.addEventListener("submit", function(){
    // hidden page=1은 그대로, 추가 작업 없음
  });
})();

  function getSelectedIds(){
    return Array.from(document.querySelectorAll('.rowChk:checked')).map(el=>el.value).filter(Boolean);
  }
  function bulkAccept(){
    const ids = getSelectedIds();
    if(ids.length===0){ alert('선택된 항목이 없습니다.'); return; }
    const f = document.getElementById('acceptForm');
    document.getElementById('acceptIds').value = ids.join(',');
    f.submit();
  }
  function bulkXlsx(){
    const ids = getSelectedIds();
    if(ids.length===0){ alert('선택된 항목이 없습니다.'); return; }
    const f = document.getElementById('xlsxForm');
    document.getElementById('xlsxIds').value = ids.join(',');
    f.submit();
  }
  function bulkSendReport(){
    const ids = getSelectedIds();
    if(ids.length===0){ alert('선택된 항목이 없습니다.'); return; }
    document.getElementById('sendIds').value = ids.join(',');
    document.getElementById('sendForm').submit();
  }

  function toggleAll(master){
      document.querySelectorAll('.rowChk').forEach(cb=>cb.checked = master.checked);
  }

  // 날짜 입력 보정(YYYY-MM-DD)
  document.querySelectorAll('.date-ymd').forEach(inp=>{
    inp.addEventListener('input', e=>{
      let v = e.target.value.replace(/[^\d]/g,'').slice(0,8);
      if (v.length>=5) v = v.slice(0,4)+'-'+v.slice(4);
      if (v.length>=8) v = v.slice(0,7)+'-'+v.slice(7);
      e.target.value = v;
    });
  });

// 현재 필터 포함 URL을 next로 세팅 (리다이렉트 시 필터 유지)
// 단, msg 파라미터는 반복 알림 방지를 위해 제외
(function(){
  const u = new URL(window.location.href);
  u.searchParams.delete("msg");
  const nextUrl = u.pathname + (u.search ? u.search : "");

  const a = document.getElementById("acceptNext");
  if (a) a.value = nextUrl;

  const x = document.getElementById("xlsxNext");
  if (x) x.value = nextUrl;

  const s = document.getElementById("sendNext");
  if (s) s.value = nextUrl;

  document.querySelectorAll("input.rowNext").forEach(el => el.value = nextUrl);
})();



// 담당자 툴팁: ⓘ 클릭 토글, 바깥 클릭/ESC 닫기
(function(){
  function hideAll(){
    document.querySelectorAll('.tooltip').forEach(t => t.style.display = 'none');
  }

  document.addEventListener('click', function(e){
    const icon = e.target.closest('.info-icon');
    if (icon){
      e.preventDefault();
      e.stopPropagation();
      const id = icon.getAttribute('data-tip-id');
      const tip = document.getElementById(id);
      if (!tip) return;

      const isOpen = (tip.style.display === 'block');
      hideAll();
      tip.style.display = isOpen ? 'none' : 'block';
      return;
    }

    if (e.target.closest('.tooltip')) return;
    hideAll();
  });

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') hideAll();
  });
})();


(function(){
  const msg = {{ (msg or "") | tojson }};
  if (!msg) return;

  alert(msg);

  // alert 후 msg 제거(재알림 방지)
  const u = new URL(window.location.href);
  u.searchParams.delete("msg");
  history.replaceState({}, "", u.pathname + (u.search ? u.search : ""));
})();


</script>

</div>
{% endblock %}